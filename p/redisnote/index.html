<!DOCTYPE html>
<html lang="en-us" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='Redis 笔记 概述 Redis能干嘛  内存存储、持久化 高速缓存 发布订阅系统 地图信息分析 计时器、计数器（浏览量） &amp;hellip;  Windows安装Redis  下载地址：https://github.com/tporadowski/redis/releases 下载解压后打开redis-server.exe和redis-cli.exe  ​	​	输入ping测试连接，set设置key value，get获取  Linux安装Redis   下载安装包https://redis.io/download/
  tar -zxvf redis-7.0.4.tar.gz 解压
  yum install gcc-c&#43;&#43;安装环境
  进入redis解压目录make &amp;amp;&amp;amp; make install
  redis默认安装目录：/usr/local/bin
  redis默认不是后台启动，修改配置daemonize为yes
启动redis服务：进入/usr/local/bin/，执行redis-server ../src/redis-7.0.4/redis.conf 客户端连接redis：redis-cli -p 6379 查看redis进程：ps -ef|grep redis 关闭redis服务：shutdown，exit    ​	性能测试 redis-benchmark是一个压力测试工具
 测试100个并发连接，100000个请求  redis-benchmark -h localhost -p 6379 -c 100 -n 100000    基础知识  默认16个数据库，默认使用第0个  1 2 3 4 5 6 7 8 9  select &amp;lt;dbid&amp;gt; #切换数据库 dbsize #查看数据库大小 keys * #查看数据库中所有key flushdb #清空当前数据库 flushall #清空所有数据库   Redis是单线程的  官方表示Redis是基于内存操作，CPU不是Redis的性能瓶颈，Redis的瓶颈是根据机器的内存和网路带宽，既然可以用单线程实现，就使用了单线程 单线程为什么还这么快？  误区1：高性能的服务器一定是多线程的 误区2：多线程一定比单线程效率高 对于Redis来说，所有数据全部放在内存中，对于内存系统来说不需要上下文切换，所以单线程比多线程效率更高      五大数据类型 Redis-Key 1 2 3 4 5 6 7 8 9  exists {key} #当前数据库是否存在某个key move {key} {db} #将key移动到数据库db中 expire {key} {seconds} #设置key的过期时间为seconds秒 ttl {key} #查看key的剩余过期时间 type {key} #查看key的类型   String (字符串) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  set {key} {value} get {key} {value} append {key} {value} #在key值中追加value，如果key不存在就相当于set key strlen {key} #查看key的长度 incr {key} #key值自增1 decr {key} #key值自减1 incrby {key} {increment} #key值自增increment decrby {key} {increment} #key值自减increment getrange {key} {start} {end} #截取key值的start到end setrange {key} {start} {value} #start开始替换key值为value setex {key} {seconds} {value} #设置key值为value，seconds秒后过期，setex (set with expire) setnx {key} {value} #如果key不存在，设置key值为value，setnx (set if not expire) mset {key1} {value1} {key2} {value2} #批量设置 mget {key1} {key2} #批量获取 msetnx {key1} {value1} {key2} {value2} #如果所有key都不存在，批量设置 mset {object}:{id}:{field} #key命名方式 getset {key} {value} #先获取key值，再设置key   List (列表) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  lpush {key} {value} #左插入value rpush {key} {value} #右插入value lrange {key} {start} {end} #获取从start到end的值 lpop {key} #移除list左侧的值 rpop {key} #移除list右侧的值 lindex {key} {index} #获取下标为index的值 llen {key} #获取list长度 lrem {key} {count} {value} #移除key中count个值为value的元素 ltrim {key} {start} {end} #从start到end截取list rpoplpush {source} {destination} #移除source中的右侧值插入destination中左侧 lset {key} {index} {item} #将list中下标为index的元素替换为item linsert {key} [before|after] {pivot} {element} #在第一个值为pivot的元素前或后面插入element   Set (集合)  集合中的元素不能重复  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  sadd {key} {members.'><title>Redis笔记</title>

<link rel='canonical' href='https://WangZichen99.github.io/p/redisnote/'>

<link rel="stylesheet" href="/scss/style.min.5a8e892f6fa14515e9065eee1f5d2e05302606ec7f11750b2fb95198f9cdcbfd.css"><meta property='og:title' content='Redis笔记'>
<meta property='og:description' content='Redis 笔记 概述 Redis能干嘛  内存存储、持久化 高速缓存 发布订阅系统 地图信息分析 计时器、计数器（浏览量） &amp;hellip;  Windows安装Redis  下载地址：https://github.com/tporadowski/redis/releases 下载解压后打开redis-server.exe和redis-cli.exe  ​	​	输入ping测试连接，set设置key value，get获取  Linux安装Redis   下载安装包https://redis.io/download/
  tar -zxvf redis-7.0.4.tar.gz 解压
  yum install gcc-c&#43;&#43;安装环境
  进入redis解压目录make &amp;amp;&amp;amp; make install
  redis默认安装目录：/usr/local/bin
  redis默认不是后台启动，修改配置daemonize为yes
启动redis服务：进入/usr/local/bin/，执行redis-server ../src/redis-7.0.4/redis.conf 客户端连接redis：redis-cli -p 6379 查看redis进程：ps -ef|grep redis 关闭redis服务：shutdown，exit    ​	性能测试 redis-benchmark是一个压力测试工具
 测试100个并发连接，100000个请求  redis-benchmark -h localhost -p 6379 -c 100 -n 100000    基础知识  默认16个数据库，默认使用第0个  1 2 3 4 5 6 7 8 9  select &amp;lt;dbid&amp;gt; #切换数据库 dbsize #查看数据库大小 keys * #查看数据库中所有key flushdb #清空当前数据库 flushall #清空所有数据库   Redis是单线程的  官方表示Redis是基于内存操作，CPU不是Redis的性能瓶颈，Redis的瓶颈是根据机器的内存和网路带宽，既然可以用单线程实现，就使用了单线程 单线程为什么还这么快？  误区1：高性能的服务器一定是多线程的 误区2：多线程一定比单线程效率高 对于Redis来说，所有数据全部放在内存中，对于内存系统来说不需要上下文切换，所以单线程比多线程效率更高      五大数据类型 Redis-Key 1 2 3 4 5 6 7 8 9  exists {key} #当前数据库是否存在某个key move {key} {db} #将key移动到数据库db中 expire {key} {seconds} #设置key的过期时间为seconds秒 ttl {key} #查看key的剩余过期时间 type {key} #查看key的类型   String (字符串) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  set {key} {value} get {key} {value} append {key} {value} #在key值中追加value，如果key不存在就相当于set key strlen {key} #查看key的长度 incr {key} #key值自增1 decr {key} #key值自减1 incrby {key} {increment} #key值自增increment decrby {key} {increment} #key值自减increment getrange {key} {start} {end} #截取key值的start到end setrange {key} {start} {value} #start开始替换key值为value setex {key} {seconds} {value} #设置key值为value，seconds秒后过期，setex (set with expire) setnx {key} {value} #如果key不存在，设置key值为value，setnx (set if not expire) mset {key1} {value1} {key2} {value2} #批量设置 mget {key1} {key2} #批量获取 msetnx {key1} {value1} {key2} {value2} #如果所有key都不存在，批量设置 mset {object}:{id}:{field} #key命名方式 getset {key} {value} #先获取key值，再设置key   List (列表) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  lpush {key} {value} #左插入value rpush {key} {value} #右插入value lrange {key} {start} {end} #获取从start到end的值 lpop {key} #移除list左侧的值 rpop {key} #移除list右侧的值 lindex {key} {index} #获取下标为index的值 llen {key} #获取list长度 lrem {key} {count} {value} #移除key中count个值为value的元素 ltrim {key} {start} {end} #从start到end截取list rpoplpush {source} {destination} #移除source中的右侧值插入destination中左侧 lset {key} {index} {item} #将list中下标为index的元素替换为item linsert {key} [before|after] {pivot} {element} #在第一个值为pivot的元素前或后面插入element   Set (集合)  集合中的元素不能重复  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  sadd {key} {members.'>
<meta property='og:url' content='https://WangZichen99.github.io/p/redisnote/'>
<meta property='og:site_name' content='wzc blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='Redis' /><meta property='article:tag' content='NoSQL' /><meta property='article:published_time' content='2022-08-14T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2022-08-14T00:00:00&#43;00:00'/><meta property='og:image' content='https://WangZichen99.github.io/img/2022/11/autumn_forest.jpg' />
<meta name="twitter:title" content="Redis笔记">
<meta name="twitter:description" content="Redis 笔记 概述 Redis能干嘛  内存存储、持久化 高速缓存 发布订阅系统 地图信息分析 计时器、计数器（浏览量） &amp;hellip;  Windows安装Redis  下载地址：https://github.com/tporadowski/redis/releases 下载解压后打开redis-server.exe和redis-cli.exe  ​	​	输入ping测试连接，set设置key value，get获取  Linux安装Redis   下载安装包https://redis.io/download/
  tar -zxvf redis-7.0.4.tar.gz 解压
  yum install gcc-c&#43;&#43;安装环境
  进入redis解压目录make &amp;amp;&amp;amp; make install
  redis默认安装目录：/usr/local/bin
  redis默认不是后台启动，修改配置daemonize为yes
启动redis服务：进入/usr/local/bin/，执行redis-server ../src/redis-7.0.4/redis.conf 客户端连接redis：redis-cli -p 6379 查看redis进程：ps -ef|grep redis 关闭redis服务：shutdown，exit    ​	性能测试 redis-benchmark是一个压力测试工具
 测试100个并发连接，100000个请求  redis-benchmark -h localhost -p 6379 -c 100 -n 100000    基础知识  默认16个数据库，默认使用第0个  1 2 3 4 5 6 7 8 9  select &amp;lt;dbid&amp;gt; #切换数据库 dbsize #查看数据库大小 keys * #查看数据库中所有key flushdb #清空当前数据库 flushall #清空所有数据库   Redis是单线程的  官方表示Redis是基于内存操作，CPU不是Redis的性能瓶颈，Redis的瓶颈是根据机器的内存和网路带宽，既然可以用单线程实现，就使用了单线程 单线程为什么还这么快？  误区1：高性能的服务器一定是多线程的 误区2：多线程一定比单线程效率高 对于Redis来说，所有数据全部放在内存中，对于内存系统来说不需要上下文切换，所以单线程比多线程效率更高      五大数据类型 Redis-Key 1 2 3 4 5 6 7 8 9  exists {key} #当前数据库是否存在某个key move {key} {db} #将key移动到数据库db中 expire {key} {seconds} #设置key的过期时间为seconds秒 ttl {key} #查看key的剩余过期时间 type {key} #查看key的类型   String (字符串) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  set {key} {value} get {key} {value} append {key} {value} #在key值中追加value，如果key不存在就相当于set key strlen {key} #查看key的长度 incr {key} #key值自增1 decr {key} #key值自减1 incrby {key} {increment} #key值自增increment decrby {key} {increment} #key值自减increment getrange {key} {start} {end} #截取key值的start到end setrange {key} {start} {value} #start开始替换key值为value setex {key} {seconds} {value} #设置key值为value，seconds秒后过期，setex (set with expire) setnx {key} {value} #如果key不存在，设置key值为value，setnx (set if not expire) mset {key1} {value1} {key2} {value2} #批量设置 mget {key1} {key2} #批量获取 msetnx {key1} {value1} {key2} {value2} #如果所有key都不存在，批量设置 mset {object}:{id}:{field} #key命名方式 getset {key} {value} #先获取key值，再设置key   List (列表) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  lpush {key} {value} #左插入value rpush {key} {value} #右插入value lrange {key} {start} {end} #获取从start到end的值 lpop {key} #移除list左侧的值 rpop {key} #移除list右侧的值 lindex {key} {index} #获取下标为index的值 llen {key} #获取list长度 lrem {key} {count} {value} #移除key中count个值为value的元素 ltrim {key} {start} {end} #从start到end截取list rpoplpush {source} {destination} #移除source中的右侧值插入destination中左侧 lset {key} {index} {item} #将list中下标为index的元素替换为item linsert {key} [before|after] {pivot} {element} #在第一个值为pivot的元素前或后面插入element   Set (集合)  集合中的元素不能重复  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  sadd {key} {members."><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://WangZichen99.github.io/img/2022/11/autumn_forest.jpg' />
    <link rel="shortcut icon" href="img/logo.jpg" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/logo_hu85fde6896bfba54d009cf04dd23be76c_55757_300x0_resize_q75_box.jpg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">wzc blog</a></h1>
            <h2 class="site-description">A programmer birth in 1999.</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com/WangZichen99'
                        target="_blank"
                        title="GitHub"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        

        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        

        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        

        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档</span>
            </a>
        </li>
        
        

        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        
        

        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>链接</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>暗色模式</span>
                </li>
            
        </div>
    </ol>
</aside>
<main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/redisnote/">
                
                    <img src="/img/2022/11/autumn_forest.jpg" loading="lazy" alt="Featured image of post Redis笔记" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" >
                学习笔记
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/redisnote/">Redis笔记</a>
        </h2>
    
        
    </div>

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Aug 14, 2022</time>
            </div>
        

        
    </footer>
    

    
</div>
</header>

    <section class="article-content">
    
    
    <h1 id="redis-笔记">Redis 笔记</h1>
<h2 id="概述">概述</h2>
<h3 id="redis能干嘛">Redis能干嘛</h3>
<ol>
<li>内存存储、持久化</li>
<li>高速缓存</li>
<li>发布订阅系统</li>
<li>地图信息分析</li>
<li>计时器、计数器（浏览量）</li>
<li>&hellip;</li>
</ol>
<h2 id="windows安装redis">Windows安装Redis</h2>
<ol>
<li>下载地址：https://github.com/tporadowski/redis/releases</li>
<li>下载解压后打开redis-server.exe和redis-cli.exe</li>
</ol>
<p>​	<img src="/../../img/2022/11/redis_note/image1.png"
	
	
	
	loading="lazy"
	
		alt="image1"
	
	
></p>
<p>​	<img src="/../../img/2022/11/redis_note/image2.png"
	
	
	
	loading="lazy"
	
		alt="image2"
	
	
></p>
<ol start="3">
<li>输入ping测试连接，set设置key value，get获取</li>
</ol>
<p><img src="/../../img/2022/11/redis_note/image3.png"
	
	
	
	loading="lazy"
	
		alt="image3"
	
	
></p>
<h2 id="linux安装redis">Linux安装Redis</h2>
<ol>
<li>
<p>下载安装包https://redis.io/download/</p>
</li>
<li>
<p><code>tar -zxvf redis-7.0.4.tar.gz</code> 解压</p>
</li>
<li>
<p><code>yum install gcc-c++</code>安装环境</p>
</li>
<li>
<p>进入redis解压目录<code>make &amp;&amp; make install</code></p>
</li>
<li>
<p>redis默认安装目录：/usr/local/bin</p>
</li>
<li>
<p>redis默认不是后台启动，修改配置daemonize为yes</p>
<p><img src="/../../img/2022/11/redis_note/image4.png"
	
	
	
	loading="lazy"
	
		alt="image4"
	
	
></p>
<ol start="7">
<li>启动redis服务：进入/usr/local/bin/，执行<code>redis-server ../src/redis-7.0.4/redis.conf</code></li>
<li>客户端连接redis：<code>redis-cli -p 6379</code></li>
<li>查看redis进程：<code>ps -ef|grep redis</code></li>
<li>关闭redis服务：shutdown，exit</li>
</ol>
</li>
</ol>
<p>​	<img src="/../../img/2022/11/redis_note/image5.png"
	
	
	
	loading="lazy"
	
		alt="image5"
	
	
></p>
<h2 id="性能测试">性能测试</h2>
<p>redis-benchmark是一个压力测试工具</p>
<ul>
<li>测试100个并发连接，100000个请求
<ul>
<li><code>redis-benchmark -h localhost -p 6379 -c 100 -n 100000</code></li>
</ul>
</li>
</ul>
<h2 id="基础知识">基础知识</h2>
<ol>
<li>默认16个数据库，默认使用第0个</li>
</ol>
<p><img src="/../../img/2022/11/redis_note/image6.png"
	
	
	
	loading="lazy"
	
		alt="image6"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="k">select</span> &lt;dbid&gt; <span class="c1">#切换数据库</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">dbsize <span class="c1">#查看数据库大小</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">keys * <span class="c1">#查看数据库中所有key</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">flushdb <span class="c1">#清空当前数据库</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">flushall <span class="c1">#清空所有数据库</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>Redis是单线程的
<ul>
<li>官方表示Redis是基于内存操作，CPU不是Redis的性能瓶颈，Redis的瓶颈是根据机器的内存和网路带宽，既然可以用单线程实现，就使用了单线程</li>
<li><strong>单线程为什么还这么快？</strong>
<ul>
<li>误区1：高性能的服务器一定是多线程的</li>
<li>误区2：多线程一定比单线程效率高</li>
<li>对于Redis来说，所有数据全部放在内存中，对于内存系统来说不需要上下文切换，所以单线程比多线程效率更高</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="五大数据类型">五大数据类型</h2>
<h3 id="redis-key">Redis-Key</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">exists <span class="o">{</span>key<span class="o">}</span> <span class="c1">#当前数据库是否存在某个key</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">move <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>db<span class="o">}</span> <span class="c1">#将key移动到数据库db中</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">expire <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>seconds<span class="o">}</span> <span class="c1">#设置key的过期时间为seconds秒</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ttl <span class="o">{</span>key<span class="o">}</span> <span class="c1">#查看key的剩余过期时间</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">type</span> <span class="o">{</span>key<span class="o">}</span> <span class="c1">#查看key的类型</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="string-字符串">String (字符串)</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">set</span> <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>value<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">get <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>value<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">append <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>value<span class="o">}</span> <span class="c1">#在key值中追加value，如果key不存在就相当于set key</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">strlen <span class="o">{</span>key<span class="o">}</span> <span class="c1">#查看key的长度</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">incr <span class="o">{</span>key<span class="o">}</span> <span class="c1">#key值自增1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">decr <span class="o">{</span>key<span class="o">}</span> <span class="c1">#key值自减1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">incrby <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>increment<span class="o">}</span> <span class="c1">#key值自增increment</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">decrby <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>increment<span class="o">}</span> <span class="c1">#key值自减increment</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">getrange <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>start<span class="o">}</span> <span class="o">{</span>end<span class="o">}</span> <span class="c1">#截取key值的start到end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">setrange <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>start<span class="o">}</span> <span class="o">{</span>value<span class="o">}</span> <span class="c1">#start开始替换key值为value</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">setex <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>seconds<span class="o">}</span> <span class="o">{</span>value<span class="o">}</span> <span class="c1">#设置key值为value，seconds秒后过期，setex (set with expire)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">setnx <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>value<span class="o">}</span> <span class="c1">#如果key不存在，设置key值为value，setnx (set if not expire)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mset <span class="o">{</span>key1<span class="o">}</span> <span class="o">{</span>value1<span class="o">}</span> <span class="o">{</span>key2<span class="o">}</span> <span class="o">{</span>value2<span class="o">}</span> <span class="c1">#批量设置</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mget <span class="o">{</span>key1<span class="o">}</span> <span class="o">{</span>key2<span class="o">}</span> <span class="c1">#批量获取</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">msetnx <span class="o">{</span>key1<span class="o">}</span> <span class="o">{</span>value1<span class="o">}</span> <span class="o">{</span>key2<span class="o">}</span> <span class="o">{</span>value2<span class="o">}</span> <span class="c1">#如果所有key都不存在，批量设置</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mset <span class="o">{</span>object<span class="o">}</span>:<span class="o">{</span>id<span class="o">}</span>:<span class="o">{</span>field<span class="o">}</span> <span class="c1">#key命名方式</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">getset <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>value<span class="o">}</span> <span class="c1">#先获取key值，再设置key</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="list-列表">List (列表)</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">lpush <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>value<span class="o">}</span> <span class="c1">#左插入value</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">rpush <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>value<span class="o">}</span> <span class="c1">#右插入value</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">lrange <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>start<span class="o">}</span> <span class="o">{</span>end<span class="o">}</span> <span class="c1">#获取从start到end的值</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">lpop <span class="o">{</span>key<span class="o">}</span> <span class="c1">#移除list左侧的值</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">rpop <span class="o">{</span>key<span class="o">}</span> <span class="c1">#移除list右侧的值</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">lindex <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>index<span class="o">}</span> <span class="c1">#获取下标为index的值</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">llen <span class="o">{</span>key<span class="o">}</span> <span class="c1">#获取list长度</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">lrem <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>count<span class="o">}</span> <span class="o">{</span>value<span class="o">}</span> <span class="c1">#移除key中count个值为value的元素</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ltrim <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>start<span class="o">}</span> <span class="o">{</span>end<span class="o">}</span> <span class="c1">#从start到end截取list</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">rpoplpush <span class="o">{</span>source<span class="o">}</span> <span class="o">{</span>destination<span class="o">}</span> <span class="c1">#移除source中的右侧值插入destination中左侧</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">lset <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>index<span class="o">}</span> <span class="o">{</span>item<span class="o">}</span> <span class="c1">#将list中下标为index的元素替换为item</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">linsert <span class="o">{</span>key<span class="o">}</span> <span class="o">[</span>before<span class="p">|</span>after<span class="o">]</span> <span class="o">{</span>pivot<span class="o">}</span> <span class="o">{</span>element<span class="o">}</span> <span class="c1">#在第一个值为pivot的元素前或后面插入element</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="set-集合">Set (集合)</h3>
<ul>
<li>集合中的元素不能重复</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sadd <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>members...<span class="o">}</span> <span class="c1">#向集合中添加元素</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">smembers <span class="o">{</span>key<span class="o">}</span> <span class="c1">#查看集合中的元素</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sismember <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>member<span class="o">}</span> <span class="c1">#查看元素是否存在集合中</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">scard <span class="o">{</span>key<span class="o">}</span> <span class="c1">#查看集合中的元素个数</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">srem <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>member<span class="o">}</span> <span class="c1">#移除集合中的元素</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">srandmember <span class="o">{</span>key<span class="o">}</span> <span class="o">(</span>count<span class="o">)</span> <span class="c1">#随机输出集合中的count个元素</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">spop <span class="o">{</span>key<span class="o">}</span> <span class="o">(</span>count<span class="o">)</span> <span class="c1">#随机弹出集合中的count个元素</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">smove <span class="o">{</span>source<span class="o">}</span> <span class="o">{</span>destination<span class="o">}</span> <span class="o">{</span>member<span class="o">}</span> <span class="c1">#将一个集合中的元素移动到另一个集合</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sdiff <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>key...<span class="o">}</span> <span class="c1">#查看多个集合与第一个集合的差集</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sinter <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>key...<span class="o">}</span> <span class="c1">#查看多个集合的交集</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sunion <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>key...<span class="o">}</span> <span class="c1">#查看多个集合的并集</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="hash-哈希">Hash (哈希)</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">hset <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>field<span class="o">}</span> <span class="o">{</span>value<span class="o">}</span> <span class="c1">#设置键和值</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">hget <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>field<span class="o">}</span> <span class="c1">#获取键的值</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">hmset <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>field value...<span class="o">}</span> <span class="c1">#设置hash的多个键和值</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">hmget <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>field...<span class="o">}</span> <span class="c1">#获取hash的多个键的值</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">hgetall <span class="o">{</span>key<span class="o">}</span> <span class="c1">#获取hash的所有键和值</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">hdel <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>field...<span class="o">}</span> <span class="c1">#删除键</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">hlen <span class="o">{</span>key<span class="o">}</span> <span class="c1">#获取hash长度</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">hexists <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>field<span class="o">}</span> <span class="c1">#判断hash的键是否存在</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">hkeys <span class="o">{</span>key<span class="o">}</span> <span class="c1">#获取hash的所有键</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">hvals <span class="o">{</span>key<span class="o">}</span> <span class="c1">#获取hash的所有值</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">hincrby <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>field<span class="o">}</span> <span class="o">{</span>increment<span class="o">}</span> <span class="c1">#hash的键自增increment</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">hsetnx <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>field<span class="o">}</span> <span class="o">{</span>value<span class="o">}</span> <span class="c1">#如果hash中没有这个键就创建</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="zset-有序集合">Zset (有序集合)</h3>
<ul>
<li>一般用来做排行榜</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">zadd <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>score<span class="o">}</span> <span class="o">{</span>value<span class="o">}</span> <span class="c1">#添加value</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">zrange <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>start<span class="o">}</span> <span class="o">{</span>end<span class="o">}</span> <span class="c1">#获取zset中的值</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">zrangebyscore <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>min<span class="o">}</span> <span class="o">{</span>max<span class="o">}</span> <span class="o">[</span>withscores<span class="o">]</span> <span class="c1">#升序排列zset中score在min到max之间的元素，withscores表示打印份数</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">zrevrange <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>start<span class="o">}</span> <span class="o">{</span>end<span class="o">}</span> <span class="o">[</span>withscores<span class="o">]</span> <span class="c1">#根据score降序排列zset中下标为start到end的元素</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">zrem <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>member...<span class="o">}</span> <span class="c1">#移除zset中的某个元素</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">zcard <span class="o">{</span>key<span class="o">}</span> <span class="c1">#获取集合中的个数</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">zcount <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>min<span class="o">}</span> <span class="o">{</span>max<span class="o">}</span> <span class="c1">#获取分数在min到max之间的元素个数</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="三种特殊数据类型">三种特殊数据类型</h2>
<h3 id="geospatial-地理位置">Geospatial (地理位置)</h3>
<ul>
<li>一般用来进行附近好友的展示</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">geoadd <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>longitude<span class="o">}</span> <span class="o">{</span>latitude<span class="o">}</span> <span class="o">{</span>member<span class="o">}</span> <span class="c1">#添加地理位置</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">geopos <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>member...<span class="o">}</span> <span class="c1">#获取指定成员的位置信息</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">geodist <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>member1<span class="o">}</span> <span class="o">{</span>member2<span class="o">}</span> <span class="o">[</span>m<span class="p">|</span>km<span class="p">|</span>mi<span class="p">|</span>ft<span class="o">]</span> <span class="c1">#获取两个成员之间的绝对距离，单位：m（米）、km（千米）、mi（英里）、ft（英尺）</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">georadius <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>longitude<span class="o">}</span> <span class="o">{</span>latitude<span class="o">}</span> <span class="o">{</span>radius<span class="o">}</span> <span class="o">[</span>m<span class="p">|</span>km<span class="p">|</span>mi<span class="p">|</span>ft<span class="o">]</span> <span class="o">[</span>withcoord<span class="p">|</span>withdist<span class="o">]</span> <span class="o">[</span>count num<span class="o">]</span> <span class="c1">#获取圆形区域内的所有成员 withcoord返回成员经纬度，withdist返回距离圆心的直线距离</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">georadiusbymember <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>member<span class="o">}</span> <span class="o">{</span>radius<span class="o">}</span>  <span class="o">[</span>m<span class="p">|</span>km<span class="p">|</span>mi<span class="p">|</span>ft<span class="o">]</span> <span class="o">[</span>withcoord<span class="p">|</span>withdist<span class="o">]</span> <span class="o">[</span>count num<span class="o">]</span> <span class="c1">#获取圆形区域内的所有成员</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">geohash <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>member...<span class="o">}</span> <span class="c1">#返回成员的hash值</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="hyperloglog-基数统计">Hyperloglog (基数统计)</h3>
<ul>
<li>一般用来进行用户访问统计。如果容错，可以使用hyperloglog，如果不容错，则使用set集合来存储用户id进行统计</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">pfadd <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>element...<span class="o">}</span> <span class="c1">#添加元素</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pfcount <span class="o">{</span>key<span class="o">}</span> <span class="c1">#返回去重后的元素数量</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pfmerge <span class="o">{</span>distkey<span class="o">}</span> <span class="o">{</span>sourcekey...<span class="o">}</span> <span class="c1">#合并所有sourcekey并去重得到distkey</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="bitmaps-位图">Bitmaps (位图)</h3>
<ul>
<li>统计用户信息（是否活跃、是否登录），365天打卡信息等</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">setbit <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>offset<span class="o">}</span> <span class="o">{</span>value<span class="o">}</span> <span class="c1">#设置第offset位的值value</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">getbit <span class="o">{</span>key<span class="o">}</span> <span class="o">{</span>offset<span class="o">}</span> <span class="c1">#获取第offset位的值</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">bitcount <span class="o">{</span>key<span class="o">}</span> <span class="o">[</span>start<span class="o">]</span> <span class="o">[</span>end<span class="o">]</span> <span class="c1">#从start到end计数</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="redis事务">Redis事务</h2>
<ul>
<li><strong>redis单条命令是原子性的，但是事务是不保证原子性的</strong></li>
<li><strong>redis事务没有隔离级别的概念</strong></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">------ 队列  命令1  命令2  命令3  执行  ------
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>所有命令在事务中没有直接被执行，只有发起执行命令的时候才会被执行</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">multi <span class="c1">#开启事务</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">... <span class="c1">#命令入队</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">exec</span> <span class="c1">#执行事务</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">discard <span class="c1">#放弃事务</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>编译型异常（代码有问题，命令有错），事务中所有命令都不会被执行</p>
<p>运行时异常（1 / 0），错误命令抛出异常，其他命令正常执行</p>
</blockquote>
<h2 id="redis实现悲观锁乐观锁">Redis实现悲观锁乐观锁</h2>
<p><strong>悲观锁：</strong></p>
<ul>
<li>很悲观，认为什么时候都会出问题，做什么事情都要加锁</li>
</ul>
<p><strong>乐观锁：</strong></p>
<ul>
<li>很乐观，认为什么时候都不会出问题，所以不会上锁，更新数据的时候判断一下，是否有人修改过这个数据</li>
</ul>
<ol>
<li>获取version</li>
<li>更新的时候比较version</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">watch <span class="o">{</span>key<span class="o">}</span> <span class="c1">#加乐观锁监视key，如果监视key的值和事务执行前key的值不一致就报错，无法执行事务</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">unwatch <span class="c1">#解除监视 (解锁)，事务执行后会自动解锁</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="jedis">Jedis</h2>
<ol>
<li>
<p>导入依赖：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>redis.clients<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>jedis<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>4.3.0-m2<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>测试</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JedisTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Jedis</span><span class="o">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="o">,</span> <span class="n">6379</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">jedis</span><span class="o">.</span><span class="na">flushDB</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// String相关命令测试
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">stringTest</span><span class="o">(</span><span class="n">jedis</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 事务测试
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">multiTest</span><span class="o">(</span><span class="n">jedis</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">multiTest</span><span class="o">(</span><span class="n">Jedis</span> <span class="n">jedis</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">jedis</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&#34;hello&#34;</span><span class="o">,</span> <span class="s">&#34;init&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">jedis</span><span class="o">.</span><span class="na">watch</span><span class="o">(</span><span class="s">&#34;hello&#34;</span><span class="o">);</span> <span class="c1">//监视hello，如果值发生变化，事务不执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">jedis</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&#34;hello&#34;</span><span class="o">,</span> <span class="s">&#34;before&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Transaction</span> <span class="n">transaction</span> <span class="o">=</span> <span class="n">jedis</span><span class="o">.</span><span class="na">multi</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">transaction</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&#34;multi&#34;</span><span class="o">,</span> <span class="s">&#34;test&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// int i = 1 / 0; //运行时异常，错误命令抛出异常，其他命令正常执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">transaction</span><span class="o">.</span><span class="na">exec</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">transaction</span><span class="o">.</span><span class="na">discard</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">jedis</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;multi&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">jedis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">stringTest</span><span class="o">(</span><span class="n">Jedis</span> <span class="n">jedis</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">jedis</span><span class="o">.</span><span class="na">ping</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">jedis</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">,</span> <span class="s">&#34;wzc&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">jedis</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">jedis</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">jedis</span><span class="o">.</span><span class="na">keys</span><span class="o">(</span><span class="s">&#34;*&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">jedis</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&#34;age&#34;</span><span class="o">,</span> <span class="s">&#34;22&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">jedis</span><span class="o">.</span><span class="na">incrBy</span><span class="o">(</span><span class="s">&#34;age&#34;</span><span class="o">,</span> <span class="n">2</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">jedis</span><span class="o">.</span><span class="na">strlen</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">jedis</span><span class="o">.</span><span class="na">getrange</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="o">-</span><span class="n">1</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">jedis</span><span class="o">.</span><span class="na">setrange</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="s">&#34;robin&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">jedis</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">jedis</span><span class="o">.</span><span class="na">mset</span><span class="o">(</span><span class="s">&#34;play&#34;</span><span class="o">,</span> <span class="s">&#34;game&#34;</span><span class="o">,</span> <span class="s">&#34;climb&#34;</span><span class="o">,</span> <span class="s">&#34;mountain&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">jedis</span><span class="o">.</span><span class="na">mget</span><span class="o">(</span><span class="s">&#34;play&#34;</span><span class="o">,</span> <span class="s">&#34;climb&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h2 id="springboot整合redis">SpringBoot整合Redis</h2>
<blockquote>
<p>说明：在Spring2.X之后，原来使用的Jedis被替换为了Lettuce</p>
<p>Jedis采用直连，多线程操作不安全，解决方法是使用Jedis Pool连接池，BIO模式</p>
<p>Lettuce采用Netty，实例可以在多个线程中共享，不存在线程不安全的情况，NIO模式</p>
</blockquote>
<p>源码分析：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisAutoConfiguration</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">RedisAutoConfiguration</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@ConditionalOnMissingBean</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="o">{</span><span class="s">&#34;redisTemplate&#34;</span><span class="o">})</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@ConditionalOnSingleCandidate</span><span class="o">(</span><span class="n">RedisConnectionFactory</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//默认的RedisTemplate没有过多的设置，由于泛型不是&lt;String, Object&gt;，可以自己定义redisTemplate替换默认的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="n">RedisTemplate</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="nf">redisTemplate</span><span class="o">(</span><span class="n">RedisConnectionFactory</span> <span class="n">redisConnectionFactory</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">RedisTemplate</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">template</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RedisTemplate</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">template</span><span class="o">.</span><span class="na">setConnectionFactory</span><span class="o">(</span><span class="n">redisConnectionFactory</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">template</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@ConditionalOnMissingBean</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@ConditionalOnSingleCandidate</span><span class="o">(</span><span class="n">RedisConnectionFactory</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//由于String是Redis中最常使用的类型，所以单独提出来了一个template
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="n">StringRedisTemplate</span> <span class="nf">stringRedisTemplate</span><span class="o">(</span><span class="n">RedisConnectionFactory</span> <span class="n">redisConnectionFactory</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">StringRedisTemplate</span> <span class="n">template</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringRedisTemplate</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">template</span><span class="o">.</span><span class="na">setConnectionFactory</span><span class="o">(</span><span class="n">redisConnectionFactory</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">template</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>
<p>导入依赖</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>配置连接</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w"> </span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 	</span><span class="nt">redis</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="m">127.0.0.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">6379</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h2 id="redisconf详解">Redis.conf详解</h2>
<p>配置文件位置：/usr/local/src/redis-7.0.4/redis.conf</p>
<ol>
<li>配置文件中units对大小写不敏感</li>
</ol>
<p><img src="/../../img/2022/11/redis_note/image7.png"
	
	
	
	loading="lazy"
	
		alt="image7"
	
	
></p>
<ol start="2">
<li>redis配置文件可以引用一些外部配置</li>
</ol>
<p><img src="/../../img/2022/11/redis_note/image8.png"
	
	
	
	loading="lazy"
	
		alt="image8"
	
	
></p>
<ol start="3">
<li>
<p>绑定ip和端口</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">################################## NETWORK #####################################</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># By default, if no &#34;bind&#34; configuration directive is specified, Redis listens</span>
</span></span><span class="line"><span class="cl"><span class="c1"># for connections from all available network interfaces on the host machine.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># It is possible to listen to just one or multiple selected interfaces using</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the &#34;bind&#34; configuration directive, followed by one or more IP addresses.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Each address can be prefixed by &#34;-&#34;, which means that redis will not fail to</span>
</span></span><span class="line"><span class="cl"><span class="c1"># start if the address is not available. Being not available only refers to</span>
</span></span><span class="line"><span class="cl"><span class="c1"># addresses that does not correspond to any network interface. Addresses that</span>
</span></span><span class="line"><span class="cl"><span class="c1"># are already in use will always fail, and unsupported protocols will always BE</span>
</span></span><span class="line"><span class="cl"><span class="c1"># silently skipped.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Examples:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># bind 192.168.1.100 10.0.0.1     # listens on two specific IPv4 addresses</span>
</span></span><span class="line"><span class="cl"><span class="c1"># bind 127.0.0.1 ::1              # listens on loopback IPv4 and IPv6</span>
</span></span><span class="line"><span class="cl"><span class="c1"># bind * -::*                     # like the default, all available interfaces</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ~~~ WARNING ~~~ If the computer running Redis is directly exposed to the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># internet, binding to all the interfaces is dangerous and will expose the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># instance to everybody on the internet. So by default we uncomment the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># following bind directive, that will force Redis to listen only on the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># IPv4 and IPv6 (if available) loopback interface addresses (this means Redis</span>
</span></span><span class="line"><span class="cl"><span class="c1"># will only be able to accept client connections from the same host that it is</span>
</span></span><span class="line"><span class="cl"><span class="c1"># running on).</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># IF YOU ARE SURE YOU WANT YOUR INSTANCE TO LISTEN TO ALL THE INTERFACES</span>
</span></span><span class="line"><span class="cl"><span class="c1"># COMMENT OUT THE FOLLOWING LINE.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># You will also need to set a password unless you explicitly disable protected</span>
</span></span><span class="line"><span class="cl"><span class="c1"># mode.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
</span></span><span class="line"><span class="cl"><span class="nb">bind</span> 127.0.0.1 -::1  <span class="c1">#绑定本地的IPV4和IPV6连接，::1代表IPV6地址</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># By default, outgoing connections (from replica to master, from Sentinel to</span>
</span></span><span class="line"><span class="cl"><span class="c1"># instances, cluster bus, etc.) are not bound to a specific local address. In</span>
</span></span><span class="line"><span class="cl"><span class="c1"># most cases, this means the operating system will handle that based on routing</span>
</span></span><span class="line"><span class="cl"><span class="c1"># and the interface through which the connection goes out.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Using bind-source-addr it is possible to configure a specific address to bind</span>
</span></span><span class="line"><span class="cl"><span class="c1"># to, which may also affect how the connection gets routed.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Example:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># bind-source-addr 10.0.0.1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Protected mode is a layer of security protection, in order to avoid that</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Redis instances left open on the internet are accessed and exploited.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># When protected mode is on and the default user has no password, the server</span>
</span></span><span class="line"><span class="cl"><span class="c1"># only accepts local connections from the IPv4 address (127.0.0.1), IPv6 address</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (::1) or Unix domain sockets.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># By default protected mode is enabled. You should disable it only if</span>
</span></span><span class="line"><span class="cl"><span class="c1"># you are sure you want clients from other hosts to connect to Redis</span>
</span></span><span class="line"><span class="cl"><span class="c1"># even if no authentication is configured.</span>
</span></span><span class="line"><span class="cl">protected-mode yes  <span class="c1">#保护模式，默认开启</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Redis uses default hardened security configuration directives to reduce the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># attack surface on innocent users. Therefore, several sensitive configuration</span>
</span></span><span class="line"><span class="cl"><span class="c1"># directives are immutable, and some potentially-dangerous commands are blocked.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Configuration directives that control files that Redis writes to (e.g., &#39;dir&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># and &#39;dbfilename&#39;) and that aren&#39;t usually modified during runtime</span>
</span></span><span class="line"><span class="cl"><span class="c1"># are protected by making them immutable.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Commands that can increase the attack surface of Redis and that aren&#39;t usually</span>
</span></span><span class="line"><span class="cl"><span class="c1"># called by users are blocked by default.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># These can be exposed to either all connections or just local ones by setting</span>
</span></span><span class="line"><span class="cl"><span class="c1"># each of the configs listed below to either of these values:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># no    - Block for any connection (remain immutable)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># yes   - Allow for any connection (no protection)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># local - Allow only for local connections. Ones originating from the</span>
</span></span><span class="line"><span class="cl"><span class="c1">#         IPv4 address (127.0.0.1), IPv6 address (::1) or Unix domain sockets.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># enable-protected-configs no</span>
</span></span><span class="line"><span class="cl"><span class="c1"># enable-debug-command no</span>
</span></span><span class="line"><span class="cl"><span class="c1"># enable-module-command no</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Accept connections on the specified port, default is 6379 (IANA #815344).</span>
</span></span><span class="line"><span class="cl"><span class="c1"># If port 0 is specified Redis will not listen on a TCP socket.</span>
</span></span><span class="line"><span class="cl">port <span class="m">6379</span>  <span class="c1">#端口设置</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># TCP listen() backlog.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># In high requests-per-second environments you need a high backlog in order</span>
</span></span><span class="line"><span class="cl"><span class="c1"># to avoid slow clients connection issues. Note that the Linux kernel</span>
</span></span><span class="line"><span class="cl"><span class="c1"># will silently truncate it to the value of /proc/sys/net/core/somaxconn so</span>
</span></span><span class="line"><span class="cl"><span class="c1"># make sure to raise both the value of somaxconn and tcp_max_syn_backlog</span>
</span></span><span class="line"><span class="cl"><span class="c1"># in order to get the desired effect.</span>
</span></span><span class="line"><span class="cl">tcp-backlog <span class="m">511</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Unix socket.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Specify the path for the Unix socket that will be used to listen for</span>
</span></span><span class="line"><span class="cl"><span class="c1"># incoming connections. There is no default, so Redis will not listen</span>
</span></span><span class="line"><span class="cl"><span class="c1"># on a unix socket when not specified.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># unixsocket /run/redis.sock</span>
</span></span><span class="line"><span class="cl"><span class="c1"># unixsocketperm 700</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Close the connection after a client is idle for N seconds (0 to disable)</span>
</span></span><span class="line"><span class="cl">timeout <span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># TCP keepalive.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># If non-zero, use SO_KEEPALIVE to send TCP ACKs to clients in absence</span>
</span></span><span class="line"><span class="cl"><span class="c1"># of communication. This is useful for two reasons:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 1) Detect dead peers.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 2) Force network equipment in the middle to consider the connection to be</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    alive.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># On Linux, the specified value (in seconds) is the period used to send ACKs.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Note that to close the connection the double of the time is needed.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># On other kernels the period depends on the kernel configuration.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># A reasonable value for this option is 300 seconds, which is the new</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Redis default starting with Redis 3.2.1.</span>
</span></span><span class="line"><span class="cl">tcp-keepalive <span class="m">300</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Apply OS-specific mechanism to mark the listening socket with the specified</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ID, to support advanced routing and filtering capabilities.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># On Linux, the ID represents a connection mark.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># On FreeBSD, the ID represents a socket cookie ID.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># On OpenBSD, the ID represents a route table ID.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The default value is 0, which implies no marking is required.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># socket-mark-id 0</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>通用配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">################################# GENERAL #####################################</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># By default Redis does not run as a daemon. Use &#39;yes&#39; if you need it.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Note that Redis will write a pid file in /var/run/redis.pid when daemonized.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># When Redis is supervised by upstart or systemd, this parameter has no impact.</span>
</span></span><span class="line"><span class="cl">daemonize yes  <span class="c1">#默认以守护进程方式运行</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># If you run Redis from upstart or systemd, Redis can interact with your</span>
</span></span><span class="line"><span class="cl"><span class="c1"># supervision tree. Options:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   supervised no      - no supervision interaction</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   supervised upstart - signal upstart by putting Redis into SIGSTOP mode</span>
</span></span><span class="line"><span class="cl"><span class="c1">#                        requires &#34;expect stop&#34; in your upstart job config</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   supervised systemd - signal systemd by writing READY=1 to $NOTIFY_SOCKET</span>
</span></span><span class="line"><span class="cl"><span class="c1">#                        on startup, and updating Redis status on a regular</span>
</span></span><span class="line"><span class="cl"><span class="c1">#                        basis.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   supervised auto    - detect upstart or systemd method based on</span>
</span></span><span class="line"><span class="cl"><span class="c1">#                        UPSTART_JOB or NOTIFY_SOCKET environment variables</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Note: these supervision methods only signal &#34;process is ready.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       They do not enable continuous pings back to your supervisor.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The default is &#34;no&#34;. To run under upstart/systemd, you can simply uncomment</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the line below:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># supervised auto</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># If a pid file is specified, Redis writes it where specified at startup</span>
</span></span><span class="line"><span class="cl"><span class="c1"># and removes it at exit.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># When the server runs non daemonized, no pid file is created if none is</span>
</span></span><span class="line"><span class="cl"><span class="c1"># specified in the configuration. When the server is daemonized, the pid file</span>
</span></span><span class="line"><span class="cl"><span class="c1"># is used even if not specified, defaulting to &#34;/var/run/redis.pid&#34;.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Creating a pid file is best effort: if Redis is not able to create it</span>
</span></span><span class="line"><span class="cl"><span class="c1"># nothing bad happens, the server will start and run normally.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Note that on modern Linux systems &#34;/run/redis.pid&#34; is more conforming</span>
</span></span><span class="line"><span class="cl"><span class="c1"># and should be used instead.</span>
</span></span><span class="line"><span class="cl">pidfile /var/run/redis_6379.pid  <span class="c1">#如果以守护进程方式运行，需要指定一个pid进程文件</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Specify the server verbosity level.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># This can be one of:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># debug (a lot of information, useful for development/testing)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># verbose (many rarely useful info, but not a mess like the debug level)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># notice (moderately verbose, what you want in production probably)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># warning (only very important / critical messages are logged)</span>
</span></span><span class="line"><span class="cl">loglevel notice  <span class="c1">#日志级别</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Specify the log file name. Also the empty string can be used to force</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Redis to log on the standard output. Note that if you use standard</span>
</span></span><span class="line"><span class="cl"><span class="c1"># output for logging but daemonize, logs will be sent to /dev/null</span>
</span></span><span class="line"><span class="cl">logfile <span class="s2">&#34;&#34;</span>  <span class="c1">#日志的文件名</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># To enable logging to the system logger, just set &#39;syslog-enabled&#39; to yes,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># and optionally update the other syslog parameters to suit your needs.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># syslog-enabled no</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Specify the syslog identity.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># syslog-ident redis</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Specify the syslog facility. Must be USER or between LOCAL0-LOCAL7.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># syslog-facility local0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># To disable the built in crash log, which will possibly produce cleaner core</span>
</span></span><span class="line"><span class="cl"><span class="c1"># dumps when they are needed, uncomment the following:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># crash-log-enabled no</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># To disable the fast memory check that&#39;s run as part of the crash log, which</span>
</span></span><span class="line"><span class="cl"><span class="c1"># will possibly let redis terminate sooner, uncomment the following:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># crash-memcheck-enabled no</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set the number of databases. The default database is DB 0, you can select</span>
</span></span><span class="line"><span class="cl"><span class="c1"># a different one on a per-connection basis using SELECT &lt;dbid&gt; where</span>
</span></span><span class="line"><span class="cl"><span class="c1"># dbid is a number between 0 and &#39;databases&#39;-1</span>
</span></span><span class="line"><span class="cl">databases <span class="m">16</span>  <span class="c1">#默认数据库数量</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># By default Redis shows an ASCII art logo only when started to log to the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># standard output and if the standard output is a TTY and syslog logging is</span>
</span></span><span class="line"><span class="cl"><span class="c1"># disabled. Basically this means that normally a logo is displayed only in</span>
</span></span><span class="line"><span class="cl"><span class="c1"># interactive sessions.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># However it is possible to force the pre-4.0 behavior and always show a</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ASCII art logo in startup logs by setting the following option to yes.</span>
</span></span><span class="line"><span class="cl">always-show-logo no  <span class="c1">#是否总是显示logo</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># By default, Redis modifies the process title (as seen in &#39;top&#39; and &#39;ps&#39;) to</span>
</span></span><span class="line"><span class="cl"><span class="c1"># provide some runtime information. It is possible to disable this and leave</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the process name as executed by setting the following to no.</span>
</span></span><span class="line"><span class="cl">set-proc-title yes
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># When changing the process title, Redis uses the following template to construct</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the modified title.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Template variables are specified in curly brackets. The following variables are</span>
</span></span><span class="line"><span class="cl"><span class="c1"># supported:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># {title}           Name of process as executed if parent, or type of child process.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># {listen-addr}     Bind address or &#39;*&#39; followed by TCP or TLS port listening on, or</span>
</span></span><span class="line"><span class="cl"><span class="c1">#                   Unix socket if only that&#39;s available.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># {server-mode}     Special mode, i.e. &#34;[sentinel]&#34; or &#34;[cluster]&#34;.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># {port}            TCP port listening on, or 0.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># {tls-port}        TLS port listening on, or 0.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># {unixsocket}      Unix domain socket listening on, or &#34;&#34;.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># {config-file}     Name of configuration file used.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl">proc-title-template <span class="s2">&#34;{title} {listen-addr} {server-mode}&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>快照 (SNAPSHOTTING)</p>
<p>与持久化相关，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">################################ SNAPSHOTTING  ################################</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Save the DB to disk.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># save &lt;seconds&gt; &lt;changes&gt; [&lt;seconds&gt; &lt;changes&gt; ...]</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Redis will save the DB if the given number of seconds elapsed and it</span>
</span></span><span class="line"><span class="cl"><span class="c1"># surpassed the given number of write operations against the DB.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Snapshotting can be completely disabled with a single empty string argument</span>
</span></span><span class="line"><span class="cl"><span class="c1"># as in following example:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># save &#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Unless specified otherwise, by default Redis will save the DB:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   * After 3600 seconds (an hour) if at least 1 change was performed</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   * After 300 seconds (5 minutes) if at least 100 changes were performed</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   * After 60 seconds if at least 10000 changes were performed</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># You can set these explicitly by uncommenting the following line.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># save 3600 1 300 100 60 10000</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 如果一小时内至少有一次修改、五分钟内至少100次修改、一分钟内至少10000次修改则进行rdb持久化</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># By default Redis will stop accepting writes if RDB snapshots are enabled</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (at least one save point) and the latest background save failed.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># This will make the user aware (in a hard way) that data is not persisting</span>
</span></span><span class="line"><span class="cl"><span class="c1"># on disk properly, otherwise chances are that no one will notice and some</span>
</span></span><span class="line"><span class="cl"><span class="c1"># disaster will happen.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># If the background saving process will start working again Redis will</span>
</span></span><span class="line"><span class="cl"><span class="c1"># automatically allow writes again.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># However if you have setup your proper monitoring of the Redis server</span>
</span></span><span class="line"><span class="cl"><span class="c1"># and persistence, you may want to disable this feature so that Redis will</span>
</span></span><span class="line"><span class="cl"><span class="c1"># continue to work as usual even if there are problems with disk,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># permissions, and so forth.</span>
</span></span><span class="line"><span class="cl">stop-writes-on-bgsave-error yes  <span class="c1">#如果持久化出错，是否继续工作</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Compress string objects using LZF when dump .rdb databases?</span>
</span></span><span class="line"><span class="cl"><span class="c1"># By default compression is enabled as it&#39;s almost always a win.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># If you want to save some CPU in the saving child set it to &#39;no&#39; but</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the dataset will likely be bigger if you have compressible values or keys.</span>
</span></span><span class="line"><span class="cl">rdbcompression yes  <span class="c1">#是否压缩rdb文件，需要消耗一些cpu资源</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Since version 5 of RDB a CRC64 checksum is placed at the end of the file.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># This makes the format more resistant to corruption but there is a performance</span>
</span></span><span class="line"><span class="cl"><span class="c1"># hit to pay (around 10%) when saving and loading RDB files, so you can disable it</span>
</span></span><span class="line"><span class="cl"><span class="c1"># for maximum performances.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># RDB files created with checksum disabled have a checksum of zero that will</span>
</span></span><span class="line"><span class="cl"><span class="c1"># tell the loading code to skip the check.</span>
</span></span><span class="line"><span class="cl">rdbchecksum yes  <span class="c1">#保存rdb文件时是否进行校验</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Enables or disables full sanitization checks for ziplist and listpack etc when</span>
</span></span><span class="line"><span class="cl"><span class="c1"># loading an RDB or RESTORE payload. This reduces the chances of a assertion or</span>
</span></span><span class="line"><span class="cl"><span class="c1"># crash later on while processing commands.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Options:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   no         - Never perform full sanitization</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   yes        - Always perform full sanitization</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   clients    - Perform full sanitization only for user connections.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#                Excludes: RDB files, RESTORE commands received from the master</span>
</span></span><span class="line"><span class="cl"><span class="c1">#                connection, and client connections which have the</span>
</span></span><span class="line"><span class="cl"><span class="c1">#                skip-sanitize-payload ACL flag.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The default should be &#39;clients&#39; but since it currently affects cluster</span>
</span></span><span class="line"><span class="cl"><span class="c1"># resharding via MIGRATE, it is temporarily set to &#39;no&#39; by default.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># sanitize-dump-payload no</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># The filename where to dump the DB</span>
</span></span><span class="line"><span class="cl">dbfilename dump.rdb  <span class="c1">#rdb文件名</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Remove RDB files used by replication in instances without persistence</span>
</span></span><span class="line"><span class="cl"><span class="c1"># enabled. By default this option is disabled, however there are environments</span>
</span></span><span class="line"><span class="cl"><span class="c1"># where for regulations or other security concerns, RDB files persisted on</span>
</span></span><span class="line"><span class="cl"><span class="c1"># disk by masters in order to feed replicas, or stored on disk by replicas</span>
</span></span><span class="line"><span class="cl"><span class="c1"># in order to load them for the initial synchronization, should be deleted</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ASAP. Note that this option ONLY WORKS in instances that have both AOF</span>
</span></span><span class="line"><span class="cl"><span class="c1"># and RDB persistence disabled, otherwise is completely ignored.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># An alternative (and sometimes better) way to obtain the same effect is</span>
</span></span><span class="line"><span class="cl"><span class="c1"># to use diskless replication on both master and replicas instances. However</span>
</span></span><span class="line"><span class="cl"><span class="c1"># in the case of replicas, diskless is not always an option.</span>
</span></span><span class="line"><span class="cl">rdb-del-sync-files no  <span class="c1">#rdb文件是否删除同步锁</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># The working directory.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The DB will be written inside this directory, with the filename specified</span>
</span></span><span class="line"><span class="cl"><span class="c1"># above using the &#39;dbfilename&#39; configuration directive.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The Append Only File will also be created inside this directory.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Note that you must specify a directory here, not a file name.</span>
</span></span><span class="line"><span class="cl">dir ./  <span class="c1">#rdb文件保存目录</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>主从复制 (REPLICATION)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">################################# REPLICATION #################################</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Master-Replica replication. Use replicaof to make a Redis instance a copy of</span>
</span></span><span class="line"><span class="cl"><span class="c1"># another Redis server. A few things to understand ASAP about Redis replication.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   +------------------+      +---------------+</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   |      Master      | ---&gt; |    Replica    |</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   | (receive writes) |      |  (exact copy) |</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   +------------------+      +---------------+</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 1) Redis replication is asynchronous, but you can configure a master to</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    stop accepting writes if it appears to be not connected with at least</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    a given number of replicas.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 2) Redis replicas are able to perform a partial resynchronization with the</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    master if the replication link is lost for a relatively small amount of</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    time. You may want to configure the replication backlog size (see the next</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    sections of this file) with a sensible value depending on your needs.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 3) Replication is automatic and does not need user intervention. After a</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    network partition replicas automatically try to reconnect to masters</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    and resynchronize with them.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># replicaof &lt;masterip&gt; &lt;masterport&gt;  #配置主机的ip和端口</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># If the master is password protected (using the &#34;requirepass&#34; configuration</span>
</span></span><span class="line"><span class="cl"><span class="c1"># directive below) it is possible to tell the replica to authenticate before</span>
</span></span><span class="line"><span class="cl"><span class="c1"># starting the replication synchronization process, otherwise the master will</span>
</span></span><span class="line"><span class="cl"><span class="c1"># refuse the replica request.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># masterauth &lt;master-password&gt;  #配置主机的密码</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># However this is not enough if you are using Redis ACLs (for Redis version</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 6 or greater), and the default user is not capable of running the PSYNC</span>
</span></span><span class="line"><span class="cl"><span class="c1"># command and/or other commands needed for replication. In this case it&#39;s</span>
</span></span><span class="line"><span class="cl"><span class="c1"># better to configure a special user to use with replication, and specify the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># masteruser configuration as such:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># masteruser &lt;username&gt;  #配置主机的用户名</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># When masteruser is specified, the replica will authenticate against its</span>
</span></span><span class="line"><span class="cl"><span class="c1"># master using the new AUTH form: AUTH &lt;username&gt; &lt;password&gt;.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># When a replica loses its connection with the master, or when the replication</span>
</span></span><span class="line"><span class="cl"><span class="c1"># is still in progress, the replica can act in two different ways:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 1) if replica-serve-stale-data is set to &#39;yes&#39; (the default) the replica will</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    still reply to client requests, possibly with out of date data, or the</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    data set may just be empty if this is the first synchronization.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 2) If replica-serve-stale-data is set to &#39;no&#39; the replica will reply with error</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    &#34;MASTERDOWN Link with MASTER is down and replica-serve-stale-data is set to &#39;no&#39;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    to all data access commands, excluding commands such as:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    INFO, REPLICAOF, AUTH, SHUTDOWN, REPLCONF, ROLE, CONFIG, SUBSCRIBE,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    UNSUBSCRIBE, PSUBSCRIBE, PUNSUBSCRIBE, PUBLISH, PUBSUB, COMMAND, POST,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#    HOST and LATENCY.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl">replica-serve-stale-data yes  <span class="c1">#当主机和从机之前断开连接后，从机是否继续向客户端提供查询服务；yes表示继续提供，no表示除了不涉及查询的命令可以执行，其他命令均返回提示信息</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># You can configure a replica instance to accept writes or not. Writing against</span>
</span></span><span class="line"><span class="cl"><span class="c1"># a replica instance may be useful to store some ephemeral data (because data</span>
</span></span><span class="line"><span class="cl"><span class="c1"># written on a replica will be easily deleted after resync with the master) but</span>
</span></span><span class="line"><span class="cl"><span class="c1"># may also cause problems if clients are writing to it because of a</span>
</span></span><span class="line"><span class="cl"><span class="c1"># misconfiguration.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Since Redis 2.6 by default replicas are read-only.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Note: read only replicas are not designed to be exposed to untrusted clients</span>
</span></span><span class="line"><span class="cl"><span class="c1"># on the internet. It&#39;s just a protection layer against misuse of the instance.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Still a read only replica exports by default all the administrative commands</span>
</span></span><span class="line"><span class="cl"><span class="c1"># such as CONFIG, DEBUG, and so forth. To a limited extent you can improve</span>
</span></span><span class="line"><span class="cl"><span class="c1"># security of read only replicas using &#39;rename-command&#39; to shadow all the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># administrative / dangerous commands.</span>
</span></span><span class="line"><span class="cl">replica-read-only yes  <span class="c1">#设置从节点只读命令</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Replication SYNC strategy: disk or socket.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># New replicas and reconnecting replicas that are not able to continue the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># replication process just receiving differences, need to do what is called a</span>
</span></span><span class="line"><span class="cl"><span class="c1"># &#34;full synchronization&#34;. An RDB file is transmitted from the master to the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># replicas.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The transmission can happen in two different ways:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 1) Disk-backed: The Redis master creates a new process that writes the RDB</span>
</span></span><span class="line"><span class="cl"><span class="c1">#                 file on disk. Later the file is transferred by the parent</span>
</span></span><span class="line"><span class="cl"><span class="c1">#                 process to the replicas incrementally.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 2) Diskless: The Redis master creates a new process that directly writes the</span>
</span></span><span class="line"><span class="cl"><span class="c1">#              RDB file to replica sockets, without touching the disk at all.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># With disk-backed replication, while the RDB file is generated, more replicas</span>
</span></span><span class="line"><span class="cl"><span class="c1"># can be queued and served with the RDB file as soon as the current child</span>
</span></span><span class="line"><span class="cl"><span class="c1"># producing the RDB file finishes its work. With diskless replication instead</span>
</span></span><span class="line"><span class="cl"><span class="c1"># once the transfer starts, new replicas arriving will be queued and a new</span>
</span></span><span class="line"><span class="cl"><span class="c1"># transfer will start when the current one terminates.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># When diskless replication is used, the master waits a configurable amount of</span>
</span></span><span class="line"><span class="cl"><span class="c1"># time (in seconds) before starting the transfer in the hope that multiple</span>
</span></span><span class="line"><span class="cl"><span class="c1"># replicas will arrive and the transfer can be parallelized.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># With slow disks and fast (large bandwidth) networks, diskless replication</span>
</span></span><span class="line"><span class="cl"><span class="c1"># works better.</span>
</span></span><span class="line"><span class="cl">repl-diskless-sync yes
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># When diskless replication is enabled, it is possible to configure the delay</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the server waits in order to spawn the child that transfers the RDB via socket</span>
</span></span><span class="line"><span class="cl"><span class="c1"># to the replicas.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># This is important since once the transfer starts, it is not possible to serve</span>
</span></span><span class="line"><span class="cl"><span class="c1"># new replicas arriving, that will be queued for the next RDB transfer, so the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># server waits a delay in order to let more replicas arrive.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The delay is specified in seconds, and by default is 5 seconds. To disable</span>
</span></span><span class="line"><span class="cl"><span class="c1"># it entirely just set it to 0 seconds and the transfer will start ASAP.</span>
</span></span><span class="line"><span class="cl">repl-diskless-sync-delay <span class="m">5</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># When diskless replication is enabled with a delay, it is possible to let</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the replication start before the maximum delay is reached if the maximum</span>
</span></span><span class="line"><span class="cl"><span class="c1"># number of replicas expected have connected. Default of 0 means that the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># maximum is not defined and Redis will wait the full delay.</span>
</span></span><span class="line"><span class="cl">repl-diskless-sync-max-replicas <span class="m">0</span>
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>安全 (SECURITY)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">config get requirepass  <span class="c1">#查看密码设置</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">config <span class="nb">set</span> requirepass <span class="m">123456</span>  <span class="c1">#设置密码</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">auth <span class="m">123456</span>  <span class="c1">#使用密码登录</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>客户端限制</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">################################### CLIENTS ####################################</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set the max number of connected clients at the same time. By default</span>
</span></span><span class="line"><span class="cl"><span class="c1"># this limit is set to 10000 clients, however if the Redis server is not</span>
</span></span><span class="line"><span class="cl"><span class="c1"># able to configure the process file limit to allow for the specified limit</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the max number of allowed clients is set to the current file limit</span>
</span></span><span class="line"><span class="cl"><span class="c1"># minus 32 (as Redis reserves a few file descriptors for internal uses).</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Once the limit is reached Redis will close all the new connections sending</span>
</span></span><span class="line"><span class="cl"><span class="c1"># an error &#39;max number of clients reached&#39;.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># IMPORTANT: When Redis Cluster is used, the max number of connections is also</span>
</span></span><span class="line"><span class="cl"><span class="c1"># shared with the cluster bus: every node in the cluster will use two</span>
</span></span><span class="line"><span class="cl"><span class="c1"># connections, one incoming and another outgoing. It is important to size the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># limit accordingly in case of very large clusters.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># maxclients 10000  #设置最大客户端数量</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">############################## MEMORY MANAGEMENT ################################</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set a memory usage limit to the specified amount of bytes.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># When the memory limit is reached Redis will try to remove keys</span>
</span></span><span class="line"><span class="cl"><span class="c1"># according to the eviction policy selected (see maxmemory-policy).</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># If Redis can&#39;t remove keys according to the policy, or if the policy is</span>
</span></span><span class="line"><span class="cl"><span class="c1"># set to &#39;noeviction&#39;, Redis will start to reply with errors to commands</span>
</span></span><span class="line"><span class="cl"><span class="c1"># that would use more memory, like SET, LPUSH, and so on, and will continue</span>
</span></span><span class="line"><span class="cl"><span class="c1"># to reply to read-only commands like GET.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># This option is usually useful when using Redis as an LRU or LFU cache, or to</span>
</span></span><span class="line"><span class="cl"><span class="c1"># set a hard memory limit for an instance (using the &#39;noeviction&#39; policy).</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># WARNING: If you have replicas attached to an instance with maxmemory on,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the size of the output buffers needed to feed the replicas are subtracted</span>
</span></span><span class="line"><span class="cl"><span class="c1"># from the used memory count, so that network problems / resyncs will</span>
</span></span><span class="line"><span class="cl"><span class="c1"># not trigger a loop where keys are evicted, and in turn the output</span>
</span></span><span class="line"><span class="cl"><span class="c1"># buffer of replicas is full with DELs of keys evicted triggering the deletion</span>
</span></span><span class="line"><span class="cl"><span class="c1"># of more keys, and so forth until the database is completely emptied.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># In short... if you have replicas attached it is suggested that you set a lower</span>
</span></span><span class="line"><span class="cl"><span class="c1"># limit for maxmemory so that there is some free RAM on the system for replica</span>
</span></span><span class="line"><span class="cl"><span class="c1"># output buffers (but this is not needed if the policy is &#39;noeviction&#39;).</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># maxmemory &lt;bytes&gt;  #最大内存设置</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># MAXMEMORY POLICY: how Redis will select what to remove when maxmemory</span>
</span></span><span class="line"><span class="cl"><span class="c1"># is reached. You can select one from the following behaviors:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># volatile-lru -&gt; Evict using approximated LRU, only keys with an expire set.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># allkeys-lru -&gt; Evict any key using approximated LRU.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># volatile-lfu -&gt; Evict using approximated LFU, only keys with an expire set.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># allkeys-lfu -&gt; Evict any key using approximated LFU.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># volatile-random -&gt; Remove a random key having an expire set.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># allkeys-random -&gt; Remove a random key, any key.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># volatile-ttl -&gt; Remove the key with the nearest expire time (minor TTL)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># noeviction -&gt; Don&#39;t evict anything, just return an error on write operations.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># LRU means Least Recently Used</span>
</span></span><span class="line"><span class="cl"><span class="c1"># LFU means Least Frequently Used</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Both LRU, LFU and volatile-ttl are implemented using approximated</span>
</span></span><span class="line"><span class="cl"><span class="c1"># randomized algorithms.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Note: with any of the above policies, when there are no suitable keys for</span>
</span></span><span class="line"><span class="cl"><span class="c1"># eviction, Redis will return an error on write operations that require</span>
</span></span><span class="line"><span class="cl"><span class="c1"># more memory. These are usually commands that create new keys, add data or</span>
</span></span><span class="line"><span class="cl"><span class="c1"># modify existing keys. A few examples are: SET, INCR, HSET, LPUSH, SUNIONSTORE,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># SORT (due to the STORE argument), and EXEC (if the transaction includes any</span>
</span></span><span class="line"><span class="cl"><span class="c1"># command that requires memory).</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The default is:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># maxmemory-policy noeviction  #内存到达上限之后的处理策略</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 1.volatile-lru: 只对设置了过期时间的key进行LRU</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 2.allkeys-lru: 删除lru算法的key</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 3.volatile-random: 随机删除即将过期的key</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 4.allkeys-random: 随机删除</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 5.volatile-ttl: 删除即将过期的</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 6.noeviction: 永不过期, 返回错误</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>AOF配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">############################## APPEND ONLY MODE ###############################</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># By default Redis asynchronously dumps the dataset on disk. This mode is</span>
</span></span><span class="line"><span class="cl"><span class="c1"># good enough in many applications, but an issue with the Redis process or</span>
</span></span><span class="line"><span class="cl"><span class="c1"># a power outage may result into a few minutes of writes lost (depending on</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the configured save points).</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The Append Only File is an alternative persistence mode that provides</span>
</span></span><span class="line"><span class="cl"><span class="c1"># much better durability. For instance using the default data fsync policy</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (see later in the config file) Redis can lose just one second of writes in a</span>
</span></span><span class="line"><span class="cl"><span class="c1"># dramatic event like a server power outage, or a single write if something</span>
</span></span><span class="line"><span class="cl"><span class="c1"># wrong with the Redis process itself happens, but the operating system is</span>
</span></span><span class="line"><span class="cl"><span class="c1"># still running correctly.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># AOF and RDB persistence can be enabled at the same time without problems.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># If the AOF is enabled on startup Redis will load the AOF, that is the file</span>
</span></span><span class="line"><span class="cl"><span class="c1"># with the better durability guarantees.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Please check https://redis.io/topics/persistence for more information.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">appendonly no  <span class="c1">#默认不开启aof模式，使用rdb方式持久化，大多数情况下rdb完全够用</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># The base name of the append only file.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Redis 7 and newer use a set of append-only files to persist the dataset</span>
</span></span><span class="line"><span class="cl"><span class="c1"># and changes applied to it. There are two basic types of files in use:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - Base files, which are a snapshot representing the complete state of the</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   dataset at the time the file was created. Base files can be either in</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   the form of RDB (binary serialized) or AOF (textual commands).</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - Incremental files, which contain additional commands that were applied</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   to the dataset following the previous file.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># In addition, manifest files are used to track the files and the order in</span>
</span></span><span class="line"><span class="cl"><span class="c1"># which they were created and should be applied.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Append-only file names are created by Redis following a specific pattern.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The file name&#39;s prefix is based on the &#39;appendfilename&#39; configuration</span>
</span></span><span class="line"><span class="cl"><span class="c1"># parameter, followed by additional information about the sequence and type.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># For example, if appendfilename is set to appendonly.aof, the following file</span>
</span></span><span class="line"><span class="cl"><span class="c1"># names could be derived:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - appendonly.aof.1.base.rdb as a base file.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - appendonly.aof.1.incr.aof, appendonly.aof.2.incr.aof as incremental files.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - appendonly.aof.manifest as a manifest file.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">appendfilename <span class="s2">&#34;appendonly.aof&#34;</span>  <span class="c1">#aof文件名设置</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># For convenience, Redis stores all persistent append-only files in a dedicated</span>
</span></span><span class="line"><span class="cl"><span class="c1"># directory. The name of the directory is determined by the appenddirname</span>
</span></span><span class="line"><span class="cl"><span class="c1"># configuration parameter.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">appenddirname <span class="s2">&#34;appendonlydir&#34;</span>  <span class="c1">#aof文件目录设置</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># The fsync() call tells the Operating System to actually write data on disk</span>
</span></span><span class="line"><span class="cl"><span class="c1"># instead of waiting for more data in the output buffer. Some OS will really flush</span>
</span></span><span class="line"><span class="cl"><span class="c1"># data on disk, some other OS will just try to do it ASAP.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Redis supports three different modes:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># no: don&#39;t fsync, just let the OS flush the data when it wants. Faster.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># always: fsync after every write to the append only log. Slow, Safest.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># everysec: fsync only one time every second. Compromise.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The default is &#34;everysec&#34;, as that&#39;s usually the right compromise between</span>
</span></span><span class="line"><span class="cl"><span class="c1"># speed and data safety. It&#39;s up to you to understand if you can relax this to</span>
</span></span><span class="line"><span class="cl"><span class="c1"># &#34;no&#34; that will let the operating system flush the output buffer when</span>
</span></span><span class="line"><span class="cl"><span class="c1"># it wants, for better performances (but if you can live with the idea of</span>
</span></span><span class="line"><span class="cl"><span class="c1"># some data loss consider the default persistence mode that&#39;s snapshotting),</span>
</span></span><span class="line"><span class="cl"><span class="c1"># or on the contrary, use &#34;always&#34; that&#39;s very slow but a bit safer than</span>
</span></span><span class="line"><span class="cl"><span class="c1"># everysec.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># More details please check the following article:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># http://antirez.com/post/redis-persistence-demystified.html</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># If unsure, use &#34;everysec&#34;.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># appendfsync always  #每次修改都同步，消耗性能</span>
</span></span><span class="line"><span class="cl">appendfsync everysec  <span class="c1">#每秒执行一次同步数据，如果服务器宕机可能会丢失数据</span>
</span></span><span class="line"><span class="cl"><span class="c1"># appendfsync no  #不同步</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h2 id="redis持久化">Redis持久化</h2>
<p>Redis是内存数据库，为了防止断电易失。Redis默认采用RDB持久化方式。</p>
<h3 id="rdb">RDB</h3>
<p><img src="/../../img/2022/11/redis_note/image9.png"
	
	
	
	loading="lazy"
	
		alt="image9"
	
	
></p>
<p>在指定的时间间隔内将内存中的数据集快照写入磁盘，恢复时直接将快照读入内存中。</p>
<blockquote>
<p>步骤解读：</p>
<ol>
<li>Redis会单独创建(fork)一个子进程来进行持久化</li>
<li>子进程将内存中的数据写入临时的rdb文件(dump.rdb)</li>
<li>父进程则继续处理Redis客户端发送的指令</li>
<li>临时rdb生成完成后，将新的rdb文件替换之前持久化生成的文件，子进程结束</li>
</ol>
<p>整个过程主进程不会进行任何IO操作，所以保证了性能，但缺点是最后一次持久化后的数据可能会丢失。</p>
</blockquote>
<p><strong>RDB持久化触发情景：</strong></p>
<ol>
<li>满足配置文件中设置的save配置时</li>
<li>redis客户端发送save命令</li>
<li>退出redis服务(shutdown命令)时</li>
<li>执行flushall命令时</li>
</ol>
<p>只要将rdb文件放在redis启动目录下，redis启动时会自动检查并读取rdb文件进行数据恢复</p>
<p>查看redis启动目录：<code>config get dir</code></p>
<p><strong>优点</strong></p>
<ol>
<li>适合大规模的数据恢复</li>
<li>对数据完成性要求不高，如果redis服务器在还不满足save配置的时候宕机，就会发生数据丢失</li>
</ol>
<p><strong>缺点</strong></p>
<ol>
<li>需要满足save配置的时间间隔才会触发rdb持久化</li>
<li>如果服务器宕机，最后一次持久化后修改的数据会丢失</li>
</ol>
<h3 id="aof-append-only-file">AOF (Append Only File)</h3>
<p>将所有命令记录下来（历史记录），恢复的时候就是把这个文件重新执行一遍。</p>
<p><img src="/../../img/2022/11/redis_note/image10.png"
	
	
	
	loading="lazy"
	
		alt="image10"
	
	
></p>
<p>以日志的形式记录每个写命令，追加到日志结尾。</p>
<p>redis启动后会读取该文件重新构建数据，也就是重新执行一遍日志中记录的所有写操作。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">############################## APPEND ONLY MODE ###############################</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># By default Redis asynchronously dumps the dataset on disk. This mode is</span>
</span></span><span class="line"><span class="cl"><span class="c1"># good enough in many applications, but an issue with the Redis process or</span>
</span></span><span class="line"><span class="cl"><span class="c1"># a power outage may result into a few minutes of writes lost (depending on</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the configured save points).</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The Append Only File is an alternative persistence mode that provides</span>
</span></span><span class="line"><span class="cl"><span class="c1"># much better durability. For instance using the default data fsync policy</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (see later in the config file) Redis can lose just one second of writes in a</span>
</span></span><span class="line"><span class="cl"><span class="c1"># dramatic event like a server power outage, or a single write if something</span>
</span></span><span class="line"><span class="cl"><span class="c1"># wrong with the Redis process itself happens, but the operating system is</span>
</span></span><span class="line"><span class="cl"><span class="c1"># still running correctly.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># AOF and RDB persistence can be enabled at the same time without problems.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># If the AOF is enabled on startup Redis will load the AOF, that is the file</span>
</span></span><span class="line"><span class="cl"><span class="c1"># with the better durability guarantees.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Please check https://redis.io/topics/persistence for more information.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">appendonly no  <span class="c1">#默认是不开启的，设置成yes为开启</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># The base name of the append only file.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Redis 7 and newer use a set of append-only files to persist the dataset</span>
</span></span><span class="line"><span class="cl"><span class="c1"># and changes applied to it. There are two basic types of files in use:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - Base files, which are a snapshot representing the complete state of the</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   dataset at the time the file was created. Base files can be either in</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   the form of RDB (binary serialized) or AOF (textual commands).</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - Incremental files, which contain additional commands that were applied</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   to the dataset following the previous file.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># In addition, manifest files are used to track the files and the order in</span>
</span></span><span class="line"><span class="cl"><span class="c1"># which they were created and should be applied.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Append-only file names are created by Redis following a specific pattern.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The file name&#39;s prefix is based on the &#39;appendfilename&#39; configuration</span>
</span></span><span class="line"><span class="cl"><span class="c1"># parameter, followed by additional information about the sequence and type.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># For example, if appendfilename is set to appendonly.aof, the following file</span>
</span></span><span class="line"><span class="cl"><span class="c1"># names could be derived:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - appendonly.aof.1.base.rdb as a base file.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - appendonly.aof.1.incr.aof, appendonly.aof.2.incr.aof as incremental files.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - appendonly.aof.manifest as a manifest file.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">appendfilename <span class="s2">&#34;appendonly.aof&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># For convenience, Redis stores all persistent append-only files in a dedicated</span>
</span></span><span class="line"><span class="cl"><span class="c1"># directory. The name of the directory is determined by the appenddirname</span>
</span></span><span class="line"><span class="cl"><span class="c1"># configuration parameter.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">appenddirname <span class="s2">&#34;appendonlydir&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># The fsync() call tells the Operating System to actually write data on disk</span>
</span></span><span class="line"><span class="cl"><span class="c1"># instead of waiting for more data in the output buffer. Some OS will really flush</span>
</span></span><span class="line"><span class="cl"><span class="c1"># data on disk, some other OS will just try to do it ASAP.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Redis supports three different modes:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># no: don&#39;t fsync, just let the OS flush the data when it wants. Faster.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># always: fsync after every write to the append only log. Slow, Safest.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># everysec: fsync only one time every second. Compromise.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The default is &#34;everysec&#34;, as that&#39;s usually the right compromise between</span>
</span></span><span class="line"><span class="cl"><span class="c1"># speed and data safety. It&#39;s up to you to understand if you can relax this to</span>
</span></span><span class="line"><span class="cl"><span class="c1"># &#34;no&#34; that will let the operating system flush the output buffer when</span>
</span></span><span class="line"><span class="cl"><span class="c1"># it wants, for better performances (but if you can live with the idea of</span>
</span></span><span class="line"><span class="cl"><span class="c1"># some data loss consider the default persistence mode that&#39;s snapshotting),</span>
</span></span><span class="line"><span class="cl"><span class="c1"># or on the contrary, use &#34;always&#34; that&#39;s very slow but a bit safer than</span>
</span></span><span class="line"><span class="cl"><span class="c1"># everysec.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># More details please check the following article:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># http://antirez.com/post/redis-persistence-demystified.html</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># If unsure, use &#34;everysec&#34;.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># appendfsync always  #每次修改追加一次，并同步到磁盘</span>
</span></span><span class="line"><span class="cl">appendfsync everysec  <span class="c1">#aof持久化策略，每秒钟追加一次，并同步到磁盘中</span>
</span></span><span class="line"><span class="cl"><span class="c1"># appendfsync no  #只追加到aof文件，不写入磁盘，交给操作系统去决定什么时候要写到磁盘</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># When the AOF fsync policy is set to always or everysec, and a background</span>
</span></span><span class="line"><span class="cl"><span class="c1"># saving process (a background save or AOF log background rewriting) is</span>
</span></span><span class="line"><span class="cl"><span class="c1"># performing a lot of I/O against the disk, in some Linux configurations</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Redis may block too long on the fsync() call. Note that there is no fix for</span>
</span></span><span class="line"><span class="cl"><span class="c1"># this currently, as even performing fsync in a different thread will block</span>
</span></span><span class="line"><span class="cl"><span class="c1"># our synchronous write(2) call.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># In order to mitigate this problem it&#39;s possible to use the following option</span>
</span></span><span class="line"><span class="cl"><span class="c1"># that will prevent fsync() from being called in the main process while a</span>
</span></span><span class="line"><span class="cl"><span class="c1"># BGSAVE or BGREWRITEAOF is in progress.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># This means that while another child is saving, the durability of Redis is</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the same as &#34;appendfsync no&#34;. In practical terms, this means that it is</span>
</span></span><span class="line"><span class="cl"><span class="c1"># possible to lose up to 30 seconds of log in the worst scenario (with the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># default Linux settings).</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># If you have latency problems turn this to &#34;yes&#34;. Otherwise leave it as</span>
</span></span><span class="line"><span class="cl"><span class="c1"># &#34;no&#34; that is the safest pick from the point of view of durability.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">no-appendfsync-on-rewrite no  <span class="c1">#当写入磁盘时由于大量IO操作，可能会阻塞主进程。如果设置为yes那么就不再写入磁盘中，而是交给操作系统决定何时写入磁盘，减少了IO操作，也就不会阻塞，但是数据可能丢失，因为没有及时写入磁盘中。默认为no，这样是安全的。</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Automatic rewrite of the append only file.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Redis is able to automatically rewrite the log file implicitly calling</span>
</span></span><span class="line"><span class="cl"><span class="c1"># BGREWRITEAOF when the AOF log size grows by the specified percentage.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># This is how it works: Redis remembers the size of the AOF file after the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># latest rewrite (if no rewrite has happened since the restart, the size of</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the AOF at startup is used).</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># This base size is compared to the current size. If the current size is</span>
</span></span><span class="line"><span class="cl"><span class="c1"># bigger than the specified percentage, the rewrite is triggered. Also</span>
</span></span><span class="line"><span class="cl"><span class="c1"># you need to specify a minimal size for the AOF file to be rewritten, this</span>
</span></span><span class="line"><span class="cl"><span class="c1"># is useful to avoid rewriting the AOF file even if the percentage increase</span>
</span></span><span class="line"><span class="cl"><span class="c1"># is reached but it is still pretty small.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Specify a percentage of zero in order to disable the automatic AOF</span>
</span></span><span class="line"><span class="cl"><span class="c1"># rewrite feature.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">auto-aof-rewrite-percentage <span class="m">100</span>  <span class="c1">#当aof文件大小超过上一次重写的aof文件的百分之多少进行重写</span>
</span></span><span class="line"><span class="cl">auto-aof-rewrite-min-size 64mb  <span class="c1">#设置允许重写的最小文件大小。防止超过百分比后文件依然很小，这时如果没超过最小文件大小就不重写</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># An AOF file may be found to be truncated at the end during the Redis</span>
</span></span><span class="line"><span class="cl"><span class="c1"># startup process, when the AOF data gets loaded back into memory.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># This may happen when the system where Redis is running</span>
</span></span><span class="line"><span class="cl"><span class="c1"># crashes, especially when an ext4 filesystem is mounted without the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># data=ordered option (however this can&#39;t happen when Redis itself</span>
</span></span><span class="line"><span class="cl"><span class="c1"># crashes or aborts but the operating system still works correctly).</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Redis can either exit with an error when this happens, or load as much</span>
</span></span><span class="line"><span class="cl"><span class="c1"># data as possible (the default now) and start if the AOF file is found</span>
</span></span><span class="line"><span class="cl"><span class="c1"># to be truncated at the end. The following option controls this behavior.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># If aof-load-truncated is set to yes, a truncated AOF file is loaded and</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the Redis server starts emitting a log to inform the user of the event.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Otherwise if the option is set to no, the server aborts with an error</span>
</span></span><span class="line"><span class="cl"><span class="c1"># and refuses to start. When the option is set to no, the user requires</span>
</span></span><span class="line"><span class="cl"><span class="c1"># to fix the AOF file using the &#34;redis-check-aof&#34; utility before to restart</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the server.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Note that if the AOF file will be found to be corrupted in the middle</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the server will still exit with an error. This option only applies when</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Redis will try to read more data from the AOF file but not enough bytes</span>
</span></span><span class="line"><span class="cl"><span class="c1"># will be found.</span>
</span></span><span class="line"><span class="cl">aof-load-truncated yes
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Redis can create append-only base files in either RDB or AOF formats. Using</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the RDB format is always faster and more efficient, and disabling it is only</span>
</span></span><span class="line"><span class="cl"><span class="c1"># supported for backward compatibility purposes.</span>
</span></span><span class="line"><span class="cl">aof-use-rdb-preamble yes
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Redis supports recording timestamp annotations in the AOF to support restoring</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the data from a specific point-in-time. However, using this capability changes</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the AOF format in a way that may not be compatible with existing AOF parsers.</span>
</span></span><span class="line"><span class="cl">aof-timestamp-enabled no
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果aof文件有错误，那么无法启动redis客户端，可以用redis-check-aof来修复aof文件，但是数据会有所缺失</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">redis-check-aof --fix appendonly.aof
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>优点</strong></p>
<ol>
<li>每一次修改都追加，文件完整性好，但是性能消耗高</li>
<li>每秒同步一次，可能会丢失一秒的数据</li>
<li>从不同步，效率最高</li>
</ol>
<p><strong>缺点</strong></p>
<ol>
<li>相对于数据文件来说，aof文件要远远大于rdb文件，修复的速度也比rdb慢</li>
<li>因为aof本质上是追加写文件，是IO操作，所以aof运行效率也比rdb慢，所以redis默认就是rdb持久化</li>
</ol>
<p><strong>扩展</strong></p>
<blockquote>
<p>如果两种持久化同时开启，redis重启时会优先载入aof文件来恢复数据</p>
<p>一般rdb用于备份redis数据，只在从服务器上进行备份，15分钟备份一次，也就是save 900 1</p>
</blockquote>
<h2 id="redis发布订阅">Redis发布订阅</h2>
<p>redis发布订阅是一种消息模式，发送者发送消息，订阅者接收消息</p>
<p><img src="/../../img/2022/11/redis_note/image11.png"
	
	
	
	loading="lazy"
	
		alt="image11"
	
	
></p>
<p>redis客户端可以订阅任意数量的频道</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">psubscribe pattern...  <span class="c1">#订阅一个或多个符合给定模式的频道</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pubsub subcommand argument...  <span class="c1">#查看订阅与发布系统状态</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">publish channel message  <span class="c1">#将信息发送到指定频道</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">subscribe channel...  <span class="c1">#订阅一个或多个频道</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">punsubscribe pattern...  <span class="c1">#退订所有给定模式的频道</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">unsubscribe channel...  <span class="c1">#退订给定的频道</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>底层实现</strong></p>
<p>每个频道是一个字典，字典的键用来标识频道，字典的值是一个链表，链表中是该频道的所有订阅者</p>
<p><strong>使用场景</strong></p>
<ol>
<li>实时消息系统</li>
<li>实时聊天室</li>
<li>订阅公众号等</li>
</ol>
<h2 id="redis主从复制">Redis主从复制</h2>
<h3 id="概念">概念</h3>
<p>主从复制是指将一台Redis服务器的数据复制到从节点的服务器上，其中主节点负责写数据，从节点负责读取数据。主从复制是单向的，有主节点到从节点。主节点可以有任意个从节点，而从节点只能有一个主节点。</p>
<p><img src="/../../img/2022/11/redis_note/image12.png"
	
	
	
	loading="lazy"
	
		alt="image12"
	
	
></p>
<h3 id="作用">作用</h3>
<ol>
<li>数据备份：主从复制实现了数据的热备份</li>
<li>故障修复：当主节点出现问题可以使用从节点</li>
<li>负载均衡：主从复制加读写分离，写数据时请求主服务器，读数据时请求从服务器，可以分担服务器的访问压力</li>
<li>高可用基石：主从复制是哨兵模式和集群实施的基础</li>
</ol>
<p>一般redis需要配置两从一主，只配置一台redis服务器有两个弊端：</p>
<ol>
<li>从结构上来说，单个服务器可能宕机，并且所有请求访问一台服务器，压力太大</li>
<li>从容量上来说，单个服务器容量有限，一般单台redis服务器的最大内存使用量应该不超过20G</li>
</ol>
<h3 id="搭建环境">搭建环境</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">info replication  <span class="c1">#查看主从复制信息</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Replication</span>
</span></span><span class="line"><span class="cl">role:master  <span class="c1">#角色</span>
</span></span><span class="line"><span class="cl">connected_slaves:0  <span class="c1">#连接的从节点个数</span>
</span></span><span class="line"><span class="cl">master_failover_state:no-failover
</span></span><span class="line"><span class="cl">master_replid:9a9ee312a4acaeb3ec299c0a9082833d116fe92d
</span></span><span class="line"><span class="cl">master_replid2:0000000000000000000000000000000000000000
</span></span><span class="line"><span class="cl">master_repl_offset:0
</span></span><span class="line"><span class="cl">second_repl_offset:-1
</span></span><span class="line"><span class="cl">repl_backlog_active:0
</span></span><span class="line"><span class="cl">repl_backlog_size:1048576
</span></span><span class="line"><span class="cl">repl_backlog_first_byte_offset:0
</span></span><span class="line"><span class="cl">repl_backlog_histlen:0
</span></span></code></pre></td></tr></table>
</div>
</div><p>在一台服务器上启动3个redis服务进程来模拟一主两从</p>
<ol>
<li>复制出3个配置文件，并修改端口号、日志文件名称、dump文件名称、pid名称</li>
<li>使用不同的配置文件启动redis服务</li>
</ol>
<p><img src="/../../img/2022/11/redis_note/image13.png"
	
	
	
	loading="lazy"
	
		alt="image13"
	
	
></p>
<ol start="3">
<li>
<p>配置从机</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">slaveof host port  #配置以host:port为主机
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>在主机上可以查看到从机的信息</p>
</li>
</ol>
<p><img src="/../../img/2022/11/redis_note/image14.png"
	
	
	
	loading="lazy"
	
		alt="image14"
	
	
></p>
<p>除了通过命令配置主从之外还可以修改配置文件进行配置，这样是永久配置。具体看conf详解</p>
<h3 id="测试">测试</h3>
<p><strong>当主机断开连接后，两台从机依然是从机的角色，主机重新连接后，依然可以写数据。</strong></p>
<p><strong>当从机断开连接后再次重新连接，如果从机的角色为主机 (通过命令配置从机的方式重启后角色变为主机) ，则无法同步主机的数据，只要重新配置为从机就可以同步到主机上的所有数据；如果从机的角色还是从机 (修改配置文件的方式重启后依然为从机) ，则能够同步到宕机期间主机写入的数据。</strong></p>
<p><strong>只要从机连接到主机，从机就会向主机发送sync同步命令，主机将数据文件传送给从机，进行一次全量同步。全量同步之后主机上的写操作都是增量同步给从机。</strong></p>
<h3 id="第二种主从复制方法">第二种主从复制方法</h3>
<p><img src="/../../img/2022/11/redis_note/image15.png"
	
	
	
	loading="lazy"
	
		alt="image15"
	
	
></p>
<p>如果主机宕机后，需要手动执行<code>slaveof no one</code>命令将一个从机设置为主机。当原来的主机重新连接后就会出现两个主机，还需要用<code>slaveof ip porrt</code>手动改为从机。</p>
<h2 id="哨兵模式">哨兵模式</h2>
<p>Redis2.8之后开始提供哨兵模式，当主服务器宕机后能够自动将一台从机切换为主机</p>
<h3 id="原理">原理</h3>
<p>哨兵是一个独立的进程，通过不断向所有redis服务器发送命令来判断各个redis服务器是否宕机</p>
<p>当哨兵检测到主服务器宕机后，会自动将一台从服务器切换为主服务器，然后通过发布订阅模式通知其他的从服务器，修改配置文件，让从服务器切换主机</p>
<p><img src="/../../img/2022/11/redis_note/image16.png"
	
	
	
	loading="lazy"
	
		alt="image16"
	
	
></p>
<p>但是如果只有一个哨兵，哨兵进程也可能死掉，所以多哨兵模式就是防止一个哨兵挂掉</p>
<p><img src="/../../img/2022/11/redis_note/image17.png"
	
	
	
	loading="lazy"
	
		alt="image17"
	
	
></p>
<p>如果主服务器宕机，哨兵1检测到之后不会马上重新选择主服务器，只是认为主服务器现在不可用，这个现象称为主观下线，如果还有其他哨兵也检测到主服务器不可用，达到一定数量之后，所有哨兵会投票选出一个从服务器来暂时充当主服务器，由某个哨兵发布消息通知服务器切换自己的主服务器。</p>
<h3 id="配置哨兵模式">配置哨兵模式</h3>
<p>哨兵配置文件为sentinel.conf</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Example sentinel.conf</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># By default protected mode is disabled in sentinel mode. Sentinel is reachable</span>
</span></span><span class="line"><span class="cl"><span class="c1"># from interfaces different than localhost. Make sure the sentinel instance is</span>
</span></span><span class="line"><span class="cl"><span class="c1"># protected from the outside world via firewalling or other means.</span>
</span></span><span class="line"><span class="cl">protected-mode no  <span class="c1">#被保护模式，默认关闭</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># port &lt;sentinel-port&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The port that this sentinel instance will run on</span>
</span></span><span class="line"><span class="cl">port <span class="m">26379</span>  <span class="c1">#哨兵运行端口</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># By default Redis Sentinel does not run as a daemon. Use &#39;yes&#39; if you need it.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Note that Redis will write a pid file in /var/run/redis-sentinel.pid when</span>
</span></span><span class="line"><span class="cl"><span class="c1"># daemonized.</span>
</span></span><span class="line"><span class="cl">daemonize no  <span class="c1">#守护进程默认关闭</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># When running daemonized, Redis Sentinel writes a pid file in</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /var/run/redis-sentinel.pid by default. You can specify a custom pid file</span>
</span></span><span class="line"><span class="cl"><span class="c1"># location here.</span>
</span></span><span class="line"><span class="cl">pidfile /var/run/redis-sentinel.pid  <span class="c1">#开启守护进程后哨兵进程的pid文件</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Specify the log file name. Also the empty string can be used to force</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Sentinel to log on the standard output. Note that if you use standard</span>
</span></span><span class="line"><span class="cl"><span class="c1"># output for logging but daemonize, logs will be sent to /dev/null</span>
</span></span><span class="line"><span class="cl">logfile <span class="s2">&#34;&#34;</span>  <span class="c1">#日志文件</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># sentinel announce-ip &lt;ip&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># sentinel announce-port &lt;port&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The above two configuration directives are useful in environments where,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># because of NAT, Sentinel is reachable from outside via a non-local address.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># When announce-ip is provided, the Sentinel will claim the specified IP address</span>
</span></span><span class="line"><span class="cl"><span class="c1"># in HELLO messages used to gossip its presence, instead of auto-detecting the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># local address as it usually does.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Similarly when announce-port is provided and is valid and non-zero, Sentinel</span>
</span></span><span class="line"><span class="cl"><span class="c1"># will announce the specified TCP port.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The two options don&#39;t need to be used together, if only announce-ip is</span>
</span></span><span class="line"><span class="cl"><span class="c1"># provided, the Sentinel will announce the specified IP and the server port</span>
</span></span><span class="line"><span class="cl"><span class="c1"># as specified by the &#34;port&#34; option. If only announce-port is provided, the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Sentinel will announce the auto-detected local IP and the specified port.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Example:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># sentinel announce-ip 1.2.3.4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># dir &lt;working-directory&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Every long running process should have a well-defined working directory.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># For Redis Sentinel to chdir to /tmp at startup is the simplest thing</span>
</span></span><span class="line"><span class="cl"><span class="c1"># for the process to don&#39;t interfere with administrative tasks such as</span>
</span></span><span class="line"><span class="cl"><span class="c1"># unmounting filesystems.</span>
</span></span><span class="line"><span class="cl">dir /tmp  <span class="c1">#哨兵sentinel的工作目录</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Tells Sentinel to monitor this master, and to consider it in O_DOWN</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (Objectively Down) state only if at least &lt;quorum&gt; sentinels agree.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Note that whatever is the ODOWN quorum, a Sentinel will require to</span>
</span></span><span class="line"><span class="cl"><span class="c1"># be elected by the majority of the known Sentinels in order to</span>
</span></span><span class="line"><span class="cl"><span class="c1"># start a failover, so no failover can be performed in minority.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Replicas are auto-discovered, so you don&#39;t need to specify replicas in</span>
</span></span><span class="line"><span class="cl"><span class="c1"># any way. Sentinel itself will rewrite this configuration file adding</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the replicas using additional configuration options.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Also note that the configuration file is rewritten when a</span>
</span></span><span class="line"><span class="cl"><span class="c1"># replica is promoted to master.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Note: master name should not include special characters or spaces.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The valid charset is A-z 0-9 and the three characters &#34;.-_&#34;.</span>
</span></span><span class="line"><span class="cl">sentinel monitor mymaster 127.0.0.1 <span class="m">6379</span> <span class="m">2</span>  <span class="c1">#quorum表示当多少个哨兵检测到主服务器宕机之后开始重新选择</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># sentinel auth-pass &lt;master-name&gt; &lt;password&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Set the password to use to authenticate with the master and replicas.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Useful if there is a password set in the Redis instances to monitor.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Note that the master password is also used for replicas, so it is not</span>
</span></span><span class="line"><span class="cl"><span class="c1"># possible to set a different password in masters and replicas instances</span>
</span></span><span class="line"><span class="cl"><span class="c1"># if you want to be able to monitor these instances with Sentinel.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># However you can have Redis instances without the authentication enabled</span>
</span></span><span class="line"><span class="cl"><span class="c1"># mixed with Redis instances requiring the authentication (as long as the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># password set is the same for all the instances requiring the password) as</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the AUTH command will have no effect in Redis instances with authentication</span>
</span></span><span class="line"><span class="cl"><span class="c1"># switched off.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Example:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># sentinel auth-pass mymaster MySUPER--secret-0123passw0rd  #哨兵连接主从的密码</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># sentinel auth-user &lt;master-name&gt; &lt;username&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># This is useful in order to authenticate to instances having ACL capabilities,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># that is, running Redis 6.0 or greater. When just auth-pass is provided the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Sentinel instance will authenticate to Redis using the old &#34;AUTH &lt;pass&gt;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># method. When also an username is provided, it will use &#34;AUTH &lt;user&gt; &lt;pass&gt;&#34;.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># In the Redis servers side, the ACL to provide just minimal access to</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Sentinel instances, should be configured along the following lines:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     user sentinel-user &gt;somepassword +client +subscribe +publish \</span>
</span></span><span class="line"><span class="cl"><span class="c1">#                        +ping +info +multi +slaveof +config +client +exec on</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># sentinel down-after-milliseconds &lt;master-name&gt; &lt;milliseconds&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Number of milliseconds the master (or any attached replica or sentinel) should</span>
</span></span><span class="line"><span class="cl"><span class="c1"># be unreachable (as in, not acceptable reply to PING, continuously, for the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># specified period) in order to consider it in S_DOWN state (Subjectively</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Down).</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Default is 30 seconds.</span>
</span></span><span class="line"><span class="cl">sentinel down-after-milliseconds mymaster <span class="m">30000</span>  <span class="c1">#指定多少毫秒之后，如果主节点没有应答，哨兵就认为主节点下线，默认30秒</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># IMPORTANT NOTE: starting with Redis 6.2 ACL capability is supported for</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Sentinel mode, please refer to the Redis website https://redis.io/topics/acl</span>
</span></span><span class="line"><span class="cl"><span class="c1"># for more details.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Sentinel&#39;s ACL users are defined in the following format:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   user &lt;username&gt; ... acl rules ...</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># For example:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   user worker +@admin +@connection ~* on &gt;ffa9203c493aa99</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># For more information about ACL configuration please refer to the Redis</span>
</span></span><span class="line"><span class="cl"><span class="c1"># website at https://redis.io/topics/acl and redis server configuration </span>
</span></span><span class="line"><span class="cl"><span class="c1"># template redis.conf.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ACL LOG</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The ACL Log tracks failed commands and authentication events associated</span>
</span></span><span class="line"><span class="cl"><span class="c1"># with ACLs. The ACL Log is useful to troubleshoot failed commands blocked </span>
</span></span><span class="line"><span class="cl"><span class="c1"># by ACLs. The ACL Log is stored in memory. You can reclaim memory with </span>
</span></span><span class="line"><span class="cl"><span class="c1"># ACL LOG RESET. Define the maximum entry length of the ACL Log below.</span>
</span></span><span class="line"><span class="cl">acllog-max-len <span class="m">128</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Using an external ACL file</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Instead of configuring users here in this file, it is possible to use</span>
</span></span><span class="line"><span class="cl"><span class="c1"># a stand-alone file just listing users. The two methods cannot be mixed:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># if you configure users here and at the same time you activate the external</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ACL file, the server will refuse to start.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The format of the external ACL user file is exactly the same as the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># format that is used inside redis.conf to describe users.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># aclfile /etc/redis/sentinel-users.acl</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># requirepass &lt;password&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># You can configure Sentinel itself to require a password, however when doing</span>
</span></span><span class="line"><span class="cl"><span class="c1"># so Sentinel will try to authenticate with the same password to all the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># other Sentinels. So you need to configure all your Sentinels in a given</span>
</span></span><span class="line"><span class="cl"><span class="c1"># group with the same &#34;requirepass&#34; password. Check the following documentation</span>
</span></span><span class="line"><span class="cl"><span class="c1"># for more info: https://redis.io/topics/sentinel</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># IMPORTANT NOTE: starting with Redis 6.2 &#34;requirepass&#34; is a compatibility</span>
</span></span><span class="line"><span class="cl"><span class="c1"># layer on top of the ACL system. The option effect will be just setting</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the password for the default user. Clients will still authenticate using</span>
</span></span><span class="line"><span class="cl"><span class="c1"># AUTH &lt;password&gt; as usually, or more explicitly with AUTH default &lt;password&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># if they follow the new protocol: both will work.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># New config files are advised to use separate authentication control for</span>
</span></span><span class="line"><span class="cl"><span class="c1"># incoming connections (via ACL), and for outgoing connections (via</span>
</span></span><span class="line"><span class="cl"><span class="c1"># sentinel-user and sentinel-pass) </span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The requirepass is not compatible with aclfile option and the ACL LOAD</span>
</span></span><span class="line"><span class="cl"><span class="c1"># command, these will cause requirepass to be ignored.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># sentinel sentinel-user &lt;username&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># You can configure Sentinel to authenticate with other Sentinels with specific</span>
</span></span><span class="line"><span class="cl"><span class="c1"># user name. </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># sentinel sentinel-pass &lt;password&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The password for Sentinel to authenticate with other Sentinels. If sentinel-user</span>
</span></span><span class="line"><span class="cl"><span class="c1"># is not configured, Sentinel will use &#39;default&#39; user with sentinel-pass to authenticate.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># sentinel parallel-syncs &lt;master-name&gt; &lt;numreplicas&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># How many replicas we can reconfigure to point to the new replica simultaneously</span>
</span></span><span class="line"><span class="cl"><span class="c1"># during the failover. Use a low number if you use the replicas to serve query</span>
</span></span><span class="line"><span class="cl"><span class="c1"># to avoid that all the replicas will be unreachable at about the same</span>
</span></span><span class="line"><span class="cl"><span class="c1"># time while performing the synchronization with the master.</span>
</span></span><span class="line"><span class="cl">sentinel parallel-syncs mymaster <span class="m">1</span>  <span class="c1">#这个配置项指定了在主备切换时最多可以有多少个slave同时对新的master进行同步，这个数字越小，完成主备切换的时间就越长。但是如果这个数字太大，就意味有多少个slave因为同步数据而不可用，一般应该保证每次只有一个slave处于不能处理命令请求的状态。</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># sentinel failover-timeout &lt;master-name&gt; &lt;milliseconds&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Specifies the failover timeout in milliseconds. It is used in many ways:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - The time needed to re-start a failover after a previous failover was</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   already tried against the same master by a given Sentinel, is two</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   times the failover timeout.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - The time needed for a replica replicating to a wrong master according</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   to a Sentinel current configuration, to be forced to replicate</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   with the right master, is exactly the failover timeout (counting since</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   the moment a Sentinel detected the misconfiguration).</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - The time needed to cancel a failover that is already in progress but</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   did not produced any configuration change (SLAVEOF NO ONE yet not</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   acknowledged by the promoted replica).</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># - The maximum time a failover in progress waits for all the replicas to be</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   reconfigured as replicas of the new master. However even after this time</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   the replicas will be reconfigured by the Sentinels anyway, but not with</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   the exact parallel-syncs progression as specified.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Default is 3 minutes.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 故障转移的超时时间 failover-timeout 可以用在以下这些方面： </span>
</span></span><span class="line"><span class="cl"><span class="c1"># 1. 同一个sentinel对同一个master两次failover之间的间隔时间。</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 2. 当一个slave从一个错误的master那里同步数据开始计算时间。直到slave被纠正为向正确的master那里同步数据时。</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 3.当想要取消一个正在进行的failover所需要的时间。  </span>
</span></span><span class="line"><span class="cl"><span class="c1"># 4.当进行failover时，配置所有slaves指向新的master所需的最大时间。不过，即使过了这个超时，slaves依然会被正确配置为指向   master，但是就不按parallel-syncs所配置的规则来了</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 默认三分钟</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl">sentinel failover-timeout mymaster <span class="m">180000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># SCRIPTS EXECUTION</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># sentinel notification-script and sentinel reconfig-script are used in order</span>
</span></span><span class="line"><span class="cl"><span class="c1"># to configure scripts that are called to notify the system administrator</span>
</span></span><span class="line"><span class="cl"><span class="c1"># or to reconfigure clients after a failover. The scripts are executed</span>
</span></span><span class="line"><span class="cl"><span class="c1"># with the following rules for error handling:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># If script exits with &#34;1&#34; the execution is retried later (up to a maximum</span>
</span></span><span class="line"><span class="cl"><span class="c1"># number of times currently set to 10).</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># If script exits with &#34;2&#34; (or an higher value) the script execution is</span>
</span></span><span class="line"><span class="cl"><span class="c1"># not retried.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># If script terminates because it receives a signal the behavior is the same</span>
</span></span><span class="line"><span class="cl"><span class="c1"># as exit code 1.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># A script has a maximum running time of 60 seconds. After this limit is</span>
</span></span><span class="line"><span class="cl"><span class="c1"># reached the script is terminated with a SIGKILL and the execution retried.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># NOTIFICATION SCRIPT</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># sentinel notification-script &lt;master-name&gt; &lt;script-path&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># Call the specified notification script for any sentinel event that is</span>
</span></span><span class="line"><span class="cl"><span class="c1"># generated in the WARNING level (for instance -sdown, -odown, and so forth).</span>
</span></span><span class="line"><span class="cl"><span class="c1"># This script should notify the system administrator via email, SMS, or any</span>
</span></span><span class="line"><span class="cl"><span class="c1"># other messaging system, that there is something wrong with the monitored</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Redis systems.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The script is called with just two arguments: the first is the event type</span>
</span></span><span class="line"><span class="cl"><span class="c1"># and the second the event description.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># The script must exist and be executable in order for sentinel to start if</span>
</span></span><span class="line"><span class="cl"><span class="c1"># this option is provided.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Example:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 配置当某一事件发生时所需要执行的脚本，可以通过脚本来通知管理员，例如当系统运行不正常时发邮件通知相关人员。</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 对于脚本的运行结果有以下规则：</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 若脚本执行后返回1，那么该脚本稍后将会被再次执行，重复次数目前默认为10</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 若脚本执行后返回2，或者比2更高的一个返回值，脚本将不会重复执行。</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 如果脚本在执行过程中由于收到系统中断信号被终止了，则同返回值为1时的行为相同。</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 一个脚本的最大执行时间为60s，如果超过这个时间，脚本将会被一个SIGKILL信号终止，之后重新执行。</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># 通知型脚本:当sentinel有任何警告级别的事件发生时（比如说redis实例的主观失效和客观失效等等），将会去调用这个脚本，</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 这时这个脚本应该通过邮件，SMS等方式去通知系统管理员关于系统不正常运行的信息。调用该脚本时，将传给脚本两个参数，一个是事件# 的类型，一个是事件的描述。</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 如果sentinel.conf配置文件中配置了这个脚本路径，那么必须保证这个脚本存在于这个路径，并且是可执行的，否则sentinel无法正</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 常启动成功。</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># sentinel notification-script mymaster /var/redis/notify.sh</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CLIENTS RECONFIGURATION SCRIPT</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># sentinel client-reconfig-script &lt;master-name&gt; &lt;script-path&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># When the master changed because of a failover a script can be called in</span>
</span></span><span class="line"><span class="cl"><span class="c1"># order to perform application-specific tasks to notify the clients that the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># configuration has changed and the master is at a different address.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># The following arguments are passed to the script:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># &lt;master-name&gt; &lt;role&gt; &lt;state&gt; &lt;from-ip&gt; &lt;from-port&gt; &lt;to-ip&gt; &lt;to-port&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># &lt;state&gt; is currently always &#34;start&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># &lt;role&gt; is either &#34;leader&#34; or &#34;observer&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># The arguments from-ip, from-port, to-ip, to-port are used to communicate</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the old address of the master and the new address of the elected replica</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (now a master).</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># This script should be resistant to multiple invocations.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Example:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 客户端重新配置主节点参数脚本</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 当一个master由于failover而发生改变时，这个脚本将会被调用，通知相关的客户端关于master地址已经发生改变的信息。</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 以下参数将会在调用脚本时传给脚本:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># &lt;master-name&gt; &lt;role&gt; &lt;state&gt; &lt;from-ip&gt; &lt;from-port&gt; &lt;to-ip&gt; &lt;to-port&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 目前&lt;state&gt;总是“failover”,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># &lt;role&gt;是“leader”或者“observer”中的一个。 </span>
</span></span><span class="line"><span class="cl"><span class="c1"># 参数 from-ip, from-port, to-ip, to-port是用来和旧的master和新的master(即旧的slave)通信的</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 这个脚本应该是通用的，能被多次调用，不是针对性的。</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># sentinel client-reconfig-script mymaster /var/redis/reconfig.sh</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># SECURITY</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># By default SENTINEL SET will not be able to change the notification-script</span>
</span></span><span class="line"><span class="cl"><span class="c1"># and client-reconfig-script at runtime. This avoids a trivial security issue</span>
</span></span><span class="line"><span class="cl"><span class="c1"># where clients can set the script to anything and trigger a failover in order</span>
</span></span><span class="line"><span class="cl"><span class="c1"># to get the program executed.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sentinel deny-scripts-reconfig yes
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># REDIS COMMANDS RENAMING (DEPRECATED)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># WARNING: avoid using this option if possible, instead use ACLs.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Sometimes the Redis server has certain commands, that are needed for Sentinel</span>
</span></span><span class="line"><span class="cl"><span class="c1"># to work correctly, renamed to unguessable strings. This is often the case</span>
</span></span><span class="line"><span class="cl"><span class="c1"># of CONFIG and SLAVEOF in the context of providers that provide Redis as</span>
</span></span><span class="line"><span class="cl"><span class="c1"># a service, and don&#39;t want the customers to reconfigure the instances outside</span>
</span></span><span class="line"><span class="cl"><span class="c1"># of the administration console.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># In such case it is possible to tell Sentinel to use different command names</span>
</span></span><span class="line"><span class="cl"><span class="c1"># instead of the normal ones. For example if the master &#34;mymaster&#34;, and the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># associated replicas, have &#34;CONFIG&#34; all renamed to &#34;GUESSME&#34;, I could use:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># SENTINEL rename-command mymaster CONFIG GUESSME</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># After such configuration is set, every time Sentinel would use CONFIG it will</span>
</span></span><span class="line"><span class="cl"><span class="c1"># use GUESSME instead. Note that there is no actual need to respect the command</span>
</span></span><span class="line"><span class="cl"><span class="c1"># case, so writing &#34;config guessme&#34; is the same in the example above.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># SENTINEL SET can also be used in order to perform this configuration at runtime.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># In order to set a command back to its original name (undo the renaming), it</span>
</span></span><span class="line"><span class="cl"><span class="c1"># is possible to just rename a command to itself:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># SENTINEL rename-command mymaster CONFIG CONFIG</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># HOSTNAMES SUPPORT</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Normally Sentinel uses only IP addresses and requires SENTINEL MONITOR</span>
</span></span><span class="line"><span class="cl"><span class="c1"># to specify an IP address. Also, it requires the Redis replica-announce-ip</span>
</span></span><span class="line"><span class="cl"><span class="c1"># keyword to specify only IP addresses.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># You may enable hostnames support by enabling resolve-hostnames. Note</span>
</span></span><span class="line"><span class="cl"><span class="c1"># that you must make sure your DNS is configured properly and that DNS</span>
</span></span><span class="line"><span class="cl"><span class="c1"># resolution does not introduce very long delays.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl">SENTINEL resolve-hostnames no
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># When resolve-hostnames is enabled, Sentinel still uses IP addresses</span>
</span></span><span class="line"><span class="cl"><span class="c1"># when exposing instances to users, configuration files, etc. If you want</span>
</span></span><span class="line"><span class="cl"><span class="c1"># to retain the hostnames when announced, enable announce-hostnames below.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl">SENTINEL announce-hostnames no
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># When master_reboot_down_after_period is set to 0, Sentinel does not fail over</span>
</span></span><span class="line"><span class="cl"><span class="c1"># when receiving a -LOADING response from a master. This was the only supported</span>
</span></span><span class="line"><span class="cl"><span class="c1"># behavior before version 7.0.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Otherwise, Sentinel will use this value as the time (in ms) it is willing to</span>
</span></span><span class="line"><span class="cl"><span class="c1"># accept a -LOADING response after a master has been rebooted, before failing</span>
</span></span><span class="line"><span class="cl"><span class="c1"># over.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SENTINEL master-reboot-down-after-period mymaster <span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>启动哨兵<code>redis-sentinel ./sentinel.conf</code></p>
<p>如果主服务器宕机后重新连接，只能作为从服务器使用，因为主服务器已经选出</p>
<p><strong>优点</strong></p>
<ol>
<li>哨兵集群，基于主从复制，所以包含了主从复制的优点</li>
<li>主从可以自动切换，系统可用性更好</li>
<li>哨兵模式就是主从模式的升级，手动到自动，更加健壮</li>
</ol>
<p><strong>缺点</strong></p>
<ol>
<li>redis不好在线扩容，集群容量一旦到达上限，在线扩容十分麻烦</li>
<li>实现哨兵模式的配置非常繁琐麻烦</li>
</ol>
<h2 id="redis缓存穿透和雪崩">Redis缓存穿透和雪崩</h2>
<h3 id="缓存穿透">缓存穿透</h3>
<h4 id="概念-1">概念</h4>
<p>缓存穿透是指用户查询的数据在redis缓存中不存在，然后向数据库中查询也没有查到数据导致查询失败。这种现象发生很多次导致给数据库增加很大压力，这就是缓存穿透。比如在秒杀中，请求量剧增但是缓存没有命中导致服务器压力剧增。</p>
<h4 id="解决方案">解决方案</h4>
<ol>
<li>
<p>布隆过滤器</p>
<p>布隆过滤器是一种数据结构，对所有可能查询的参数以hash形式存储，在控制层先进行校验，不符合就丢弃，避免了对底层数据库造成压力。</p>
<p><img src="/../../img/2022/11/redis_note/image18.png"
	
	
	
	loading="lazy"
	
		alt="image18"
	
	
></p>
</li>
<li>
<p>缓存空对象</p>
<p>当数据库没有命中时，将空对象加到缓存中，同时设置一个过期时间，如果用户再查这个对象就会命中缓存，保护了底层数据库。</p>
<p>但是这种方法会存在两个问题：</p>
<ol>
<li>存储空值没有意义，并且会有越来越多没有意义的键</li>
<li>即使对空值设置了过期时间，如果原来没有值的对象被存到了数据库中就会导致一段时间缓存的值和数据库中的数据不一致的问题。</li>
</ol>
<p><img src="/../../img/2022/11/redis_note/image19.png"
	
	
	
	loading="lazy"
	
		alt="image19"
	
	
></p>
<h3 id="缓存击穿">缓存击穿</h3>
<h4 id="概念-2">概念</h4>
<p>如果缓存中的某一个key非常热点，有大量的请求命中这个key，那么在这个key失效的瞬间，这些请求就会访问数据库，给数据库带来巨大的压力。</p>
<h4 id="解决方案-1">解决方案</h4>
<ol>
<li>
<p>设置热点数据不过期</p>
<p>不过期就会一直命中，但是可能会浪费空间</p>
</li>
<li>
<p>加互斥锁</p>
<p>使用分布式锁，保证对于每个key同时只有一个线程去查询数据库，其他的线程没有获得分布式锁的权限，因此需要等待。这种方式将高并发的压力转移到了分布式锁上，对分布式锁的考验很大。</p>
</li>
</ol>
<h3 id="缓存雪崩">缓存雪崩</h3>
<h4 id="概念-3">概念</h4>
<p>缓存雪崩是指在某一个时间段缓存集中失效，或者是redis服务器宕机。原因是某些热点数据在同一时间被加入到缓存中并且过期时间也一致，这样就导致了在同一时间失效。服务器宕机带来的雪崩，其访问量是不可知的，所以有可能给数据库带来巨大的压力。</p>
<p><img src="/../../img/2022/11/redis_note/image20.png"
	
	
	
	loading="lazy"
	
		alt="image20"
	
	
></p>
<h4 id="解决方案-2">解决方案</h4>
<ol>
<li>
<p>redis高可用</p>
<p>增加redis服务器，搭建集群，高可用。</p>
</li>
<li>
<p>限流降级</p>
<p>在缓存失效后，通过加锁或者队列来控制读数据库的线程数量，比如对同一个key只允许一个线程查询数据并写入缓存，其他线程只能等待。或者是将一些无关的服务停掉</p>
</li>
<li>
<p>数据预热</p>
<p>在正式部署之前，将可能的热点数据全部访问一遍，使这些数据写入缓存。在即将发生大量并发请求前手动触发加载缓存，设置不同的过期时间，就能防止在某一时间同时失效的问题。</p>
</li>
</ol>
</li>
</ol>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/redis/">Redis</a>
        
            <a href="/tags/nosql/">NoSQL</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/nginxnote/">
        
        
            <div class="article-image">
                
                    <img src="/img/2022/07/colorful_river.jpg" loading="lazy" data-key="NginxNote" data-hash="/img/2022/07/colorful_river.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Nginx笔记</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/springbootnote/">
        
        
            <div class="article-image">
                
                    <img src="/img/2022/07/nature_park.jpg" loading="lazy" data-key="SpringBootNote" data-hash="/img/2022/07/nature_park.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">SpringBoot笔记</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/springmvcnote/">
        
        
            <div class="article-image">
                
                    <img src="/img/2022/04/beach.png" loading="lazy" data-key="SpringMVCNote" data-hash="/img/2022/04/beach.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">SpringMVC笔记</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/mybatisnote/">
        
        
            <div class="article-image">
                
                    <img src="/img/2022/03/lake.jpg" loading="lazy" data-key="MybatisNote" data-hash="/img/2022/03/lake.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Mybatis笔记</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/springnote/">
        
        
            <div class="article-image">
                
                    <img src="/img/2022/03/trees_road.jpg" loading="lazy" data-key="SpringNote" data-hash="/img/2022/03/trees_road.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Spring笔记</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "hugo-theme-stack" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2022 - 
        
        2023 wzc blog
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.12.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#概述">概述</a>
      <ol>
        <li><a href="#redis能干嘛">Redis能干嘛</a></li>
      </ol>
    </li>
    <li><a href="#windows安装redis">Windows安装Redis</a></li>
    <li><a href="#linux安装redis">Linux安装Redis</a></li>
    <li><a href="#性能测试">性能测试</a></li>
    <li><a href="#基础知识">基础知识</a></li>
    <li><a href="#五大数据类型">五大数据类型</a>
      <ol>
        <li><a href="#redis-key">Redis-Key</a></li>
        <li><a href="#string-字符串">String (字符串)</a></li>
        <li><a href="#list-列表">List (列表)</a></li>
        <li><a href="#set-集合">Set (集合)</a></li>
        <li><a href="#hash-哈希">Hash (哈希)</a></li>
        <li><a href="#zset-有序集合">Zset (有序集合)</a></li>
      </ol>
    </li>
    <li><a href="#三种特殊数据类型">三种特殊数据类型</a>
      <ol>
        <li><a href="#geospatial-地理位置">Geospatial (地理位置)</a></li>
        <li><a href="#hyperloglog-基数统计">Hyperloglog (基数统计)</a></li>
        <li><a href="#bitmaps-位图">Bitmaps (位图)</a></li>
      </ol>
    </li>
    <li><a href="#redis事务">Redis事务</a></li>
    <li><a href="#redis实现悲观锁乐观锁">Redis实现悲观锁乐观锁</a></li>
    <li><a href="#jedis">Jedis</a></li>
    <li><a href="#springboot整合redis">SpringBoot整合Redis</a></li>
    <li><a href="#redisconf详解">Redis.conf详解</a></li>
    <li><a href="#redis持久化">Redis持久化</a>
      <ol>
        <li><a href="#rdb">RDB</a></li>
        <li><a href="#aof-append-only-file">AOF (Append Only File)</a></li>
      </ol>
    </li>
    <li><a href="#redis发布订阅">Redis发布订阅</a></li>
    <li><a href="#redis主从复制">Redis主从复制</a>
      <ol>
        <li><a href="#概念">概念</a></li>
        <li><a href="#作用">作用</a></li>
        <li><a href="#搭建环境">搭建环境</a></li>
        <li><a href="#测试">测试</a></li>
        <li><a href="#第二种主从复制方法">第二种主从复制方法</a></li>
      </ol>
    </li>
    <li><a href="#哨兵模式">哨兵模式</a>
      <ol>
        <li><a href="#原理">原理</a></li>
        <li><a href="#配置哨兵模式">配置哨兵模式</a></li>
      </ol>
    </li>
    <li><a href="#redis缓存穿透和雪崩">Redis缓存穿透和雪崩</a>
      <ol>
        <li><a href="#缓存穿透">缓存穿透</a>
          <ol>
            <li><a href="#概念-1">概念</a></li>
            <li><a href="#解决方案">解决方案</a></li>
          </ol>
        </li>
        <li><a href="#缓存击穿">缓存击穿</a>
          <ol>
            <li><a href="#概念-2">概念</a></li>
            <li><a href="#解决方案-1">解决方案</a></li>
          </ol>
        </li>
        <li><a href="#缓存雪崩">缓存雪崩</a>
          <ol>
            <li><a href="#概念-3">概念</a></li>
            <li><a href="#解决方案-2">解决方案</a></li>
          </ol>
        </li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
